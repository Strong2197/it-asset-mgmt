{% extends 'base.html' %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-12">
        <div class="card shadow-sm">
            <div class="card-header bg-white d-flex justify-content-between align-items-center py-3">
                <h4 class="mb-0 text-primary">
                    <i class="bi bi-box-seam"></i> Майно
                </h4>

                <div class="d-flex gap-2 align-items-center">

                    <select id="type-filter" class="form-select bg-light" style="width: 200px; cursor: pointer;">
                        <option value="all">Всі категорії</option>
                        {% for cat in categories %}
                            <option value="{{ cat.id }}">{{ cat.name }}</option>
                        {% endfor %}
                    </select>

                    <div class="input-group" style="width: 200px;">
                        <span class="input-group-text bg-light border-end-0">
                            <i class="bi bi-search"></i>
                        </span>
                        <input type="text" id="main-search" class="form-control border-start-0 bg-light" placeholder="Пошук..." autocomplete="off">
                    </div>

                   <button onclick="exportData()" class="btn btn-outline-success" title="Завантажити в Excel (xlsx)">
    <i class="bi bi-file-earmark-excel"></i>
</button>

                    <a href="{% url 'asset_create' %}" class="btn btn-primary">
                        <i class="bi bi-plus-lg"></i> Додати
                    </a>
                </div>
            </div>

            <div class="card-body p-0">
                <div class="table-responsive">
                   <table class="table table-hover align-middle mb-0">
                        <thead class="table-light text-secondary">
                            <tr>
                                <th class="ps-4">Баркод</th>
                                <th>Інв. номер</th>
                                <th>Назва</th>
                                <th>Рахунок</th> <th>Розташування</th>
                                <th class="text-end pe-4">Дії</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for asset in assets %}
                            <tr data-type="{{ asset.category.id }}">

                                <td class="ps-4 fw-bold text-dark">
                                    {{ asset.barcode|default:"-" }}
                                </td>

                                <td class="fw-bold text-dark">
                                    {{ asset.inventory_number|default:"-" }}
                                </td>

                                <td>
                                    <a href="{% url 'asset_update' asset.pk %}" class="text-decoration-none fw-bold text-primary">
                                        {{ asset.name }}
                                    </a>
                                    <div class="small text-muted">{{ asset.category.name }}</div>
                                </td>

                                <td>
                                    {% if asset.account == '104' %}
                                        <span class="badge bg-warning text-dark border border-warning bg-opacity-25">104</span>
                                    {% elif asset.account == '113' %}
                                        <span class="badge bg-info text-dark border border-info bg-opacity-25">113</span>
                                    {% else %}
                                        <span class="badge bg-light text-dark border">{{ asset.account|default:"-" }}</span>
                                    {% endif %}
                                </td>

                                <td>
                                    <div><i class="bi bi-geo-alt text-danger small"></i> {{ asset.location }}</div>
                                </td>

                                <td class="text-end pe-4">
                                    <a href="{% url 'asset_clone' asset.pk %}" class="btn btn-sm btn-light text-success border me-1" title="Створити копію">
                                        <i class="bi bi-files"></i>
                                    </a>
                                    <a href="{% url 'asset_update' asset.pk %}" class="btn btn-sm btn-light text-primary border" title="Редагувати">
                                        <i class="bi bi-pencil"></i>
                                    </a>
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="6" class="text-center py-5 text-muted"> Майно відсутнє.
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="card-footer bg-white border-top-0 py-3">
                <small class="text-muted">Всього записів: <span id="record-count">{{ assets.count }}</span></small>
            </div>
        </div>
    </div>
</div>

<script>
// Функція для експорту з урахуванням фільтрів
function exportData() {
    // 1. Беремо значення з полів
    const searchValue = document.getElementById('main-search').value;
    const typeValue = document.getElementById('type-filter').value;

    // 2. Формуємо посилання на сервер
    // Base URL беремо з Django тега
    let url = "{% url 'export_assets_xlsx' %}";

    // 3. Додаємо параметри (GET request)
    url += `?search=${encodeURIComponent(searchValue)}&category=${typeValue}`;

    // 4. Переходимо за посиланням (починається завантаження)
    window.location.href = url;
}

// Старий скрипт живого пошуку (залишається без змін)
document.addEventListener("DOMContentLoaded", function() {
    const searchInput = document.getElementById('main-search');
    const typeFilter = document.getElementById('type-filter');
    const tableBody = document.querySelector('tbody');
    const countSpan = document.getElementById('record-count');

    if (!searchInput || !typeFilter || !tableBody) return;

    function filterTable() {
        const searchText = searchInput.value.toLowerCase();
        const selectedType = typeFilter.value;
        const rows = tableBody.getElementsByTagName('tr');
        let visibleCount = 0;

        for (let i = 0; i < rows.length; i++) {
            const row = rows[i];
            if (row.cells.length < 2) continue;

            const rowText = row.textContent.toLowerCase();
            const matchesText = rowText.includes(searchText);

            const rowType = row.getAttribute('data-type');
            const matchesType = (selectedType === 'all') || (rowType === selectedType);

            if (matchesText && matchesType) {
                row.style.display = "";
                visibleCount++;
            } else {
                row.style.display = "none";
            }
        }
        if(countSpan) countSpan.textContent = visibleCount;
    }

    searchInput.addEventListener('keyup', filterTable);
    typeFilter.addEventListener('change', filterTable);
});
</script>
{% endblock %}