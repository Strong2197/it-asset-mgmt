{% extends 'base.html' %}

{% block content %}

<style>
    #secret-match3-wrapper { font-family: sans-serif; line-height: 1.5; }
    #secret-match3-wrapper * { box-sizing: border-box; margin: 0; padding: 0; }

    #secret-match3-wrapper .m3g-overlay {
        display: none;
        position: fixed;
        top: 0; left: 0;
        width: 100vw; height: 100vh;
        background: rgba(0, 0, 0, 0.85);
        z-index: 2147483647;
        justify-content: center; align-items: center;
        backdrop-filter: blur(5px);
    }

    #secret-match3-wrapper .m3g-container {
        background: #222;
        padding: 25px;
        border-radius: 15px;
        box-shadow: 0 0 20px rgba(0,0,0,0.5);
        text-align: center;
        color: white;
        position: relative;
    }

    #secret-match3-wrapper .m3g-stats {
        display: flex;
        justify-content: space-between;
        margin-bottom: 15px;
        font-size: 1.2rem;
        font-weight: bold;
        color: #ffcc00;
        gap: 20px;
    }

    #secret-match3-wrapper .m3g-msg {
        display: none;
        background: rgba(255, 0, 0, 0.8);
        color: white;
        padding: 5px;
        border-radius: 5px;
        margin-bottom: 10px;
        font-size: 0.9rem;
        font-weight: bold;
        animation: pulse 1s infinite;
    }

    @keyframes pulse {
        0% { opacity: 0.7; }
        50% { opacity: 1; }
        100% { opacity: 0.7; }
    }

    #secret-match3-wrapper .m3g-grid {
        display: grid;
        grid-template-columns: repeat(8, 50px);
        grid-template-rows: repeat(8, 50px);
        gap: 5px;
        background-color: #333;
        padding: 5px;
        border-radius: 5px;
        margin: 0 auto;
    }

    #secret-match3-wrapper .m3g-cell {
        width: 50px; height: 50px;
        background-color: #444;
        border-radius: 8px;
        display: flex;
        justify-content: center; align-items: center;
        font-size: 30px;
        cursor: pointer;
        user-select: none;
        transition: transform 0.2s, background-color 0.2s;
    }

    #secret-match3-wrapper .m3g-cell.shake {
        animation: shake 0.3s;
        border: 2px solid red;
    }

    @keyframes shake {
        0% { transform: translateX(0); }
        25% { transform: translateX(-5px); }
        50% { transform: translateX(5px); }
        75% { transform: translateX(-5px); }
        100% { transform: translateX(0); }
    }

    #secret-match3-wrapper .m3g-cell.selected {
        background-color: #666;
        border: 2px solid #ffcc00;
        transform: scale(1.1);
    }

    #secret-match3-wrapper .m3g-close-btn {
        position: absolute; top: 10px; right: 15px;
        font-size: 28px; color: #888;
        background: none; border: none; cursor: pointer;
    }
    #secret-match3-wrapper .m3g-close-btn:hover { color: #fff; }
</style>

<style>
    /* –ï—Ñ–µ–∫—Ç –ø—ñ–¥–Ω—è—Ç—Ç—è –∫–∞—Ä—Ç–∫–∏ –ø—Ä–∏ –Ω–∞–≤–µ–¥–µ–Ω–Ω—ñ */
    .hover-lift {
        transition: transform 0.2s ease, box-shadow 0.2s ease;
    }
    .hover-lift:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 20px rgba(0,0,0,0.08) !important;
        border-color: var(--bs-primary) !important;
    }

    /* –°—Ç–∏–ª—å –¥–ª—è –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ —ñ–∫–æ–Ω–∫–∏ */
    .icon-square {
        width: 48px;
        height: 48px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 10px;
        font-size: 1.5rem;
        flex-shrink: 0;
    }

    /* –§–æ–Ω–æ–≤—ñ –∫–æ–ª—å–æ—Ä–∏ –¥–ª—è —ñ–∫–æ–Ω–æ–∫ */
    .bg-blue-subtle { background-color: rgba(13, 110, 253, 0.1); color: #0d6efd; }
    .bg-purple-subtle { background-color: rgba(111, 66, 193, 0.1); color: #6f42c1; }
    .bg-green-subtle { background-color: rgba(25, 135, 84, 0.1); color: #198754; }
    .bg-orange-subtle { background-color: rgba(253, 126, 20, 0.1); color: #fd7e14; }
    .bg-teal-subtle { background-color: rgba(32, 201, 151, 0.1); color: #20c997; }
    .bg-gray-subtle { background-color: #e9ecef; color: #495057; }

    /* –°—Ç–∏–ª—å –¥–ª—è –≤–µ–ª–∏–∫–∏—Ö —Ü–∏—Ñ—Ä */
    .stat-value {
        font-size: 1.75rem;
        font-weight: 700;
        color: #343a40;
        line-height: 1.2;
    }
    .stat-label {
        font-size: 0.85rem;
        color: #6c757d;
        font-weight: 500;
    }
</style>

<div class="py-4">
    <div class="row mb-4 align-items-center">
        <div class="col">
            <h2 class="fw-bold text-dark mb-1">–°–∏—Å—Ç–µ–º–∞ –æ–±–ª—ñ–∫—É –∞–∫—Ç–∏–≤—ñ–≤</h2>
            <p class="text-muted mb-0">–ö–µ—Ä—É–≤–∞–Ω–Ω—è –º–∞–π–Ω–æ–º —Ç–∞ —Å–µ—Ä–≤—ñ—Å–Ω–∏–º –æ–±—Å–ª—É–≥–æ–≤—É–≤–∞–Ω–Ω—è–º</p>
        </div>
        <div class="col-auto">
            <span class="text-muted small">{% now "d.m.Y" %}</span>
        </div>
    </div>

    <div class="row row-cols-1 row-cols-md-2 row-cols-xl-3 g-4">

        <div class="col">
            <div class="card h-100 border-0 shadow-sm hover-lift position-relative">
                <div class="card-body p-4">
                    <div class="d-flex align-items-center mb-3">
                        <div class="icon-square bg-blue-subtle me-3">
                            <i class="bi bi-pc-display"></i>
                        </div>
                        <div>
                            <h5 class="card-title fw-bold mb-0">–ú–∞–π–Ω–æ</h5>
                            <span class="text-muted small">–û–±–ª—ñ–∫ —Ç–µ—Ö–Ω—ñ–∫–∏</span>
                        </div>
                    </div>

                    <div class="mt-3">
                        <div class="stat-value">{{ assets_count }}</div>
                        <div class="stat-label">–æ–¥–∏–Ω–∏—Ü—å –Ω–∞ –æ–±–ª—ñ–∫—É</div>
                    </div>

                    <a href="/inventory/" class="stretched-link"></a>
                </div>
            </div>
        </div>

        <div class="col">
            <div class="card h-100 border-0 shadow-sm hover-lift position-relative">
                <div class="card-body p-4">
                    <div class="d-flex align-items-center mb-3">
                        <div class="icon-square bg-orange-subtle me-3">
                            <i class="bi bi-tools"></i>
                        </div>
                        <div>
                            <h5 class="card-title fw-bold mb-0">–°–µ—Ä–≤—ñ—Å</h5>
                            <span class="text-muted small">–†–µ–º–æ–Ω—Ç —Ç–∞ –∫–∞—Ä—Ç—Ä–∏–¥–∂—ñ</span>
                        </div>
                    </div>

                    <div class="d-flex justify-content-between mt-3 text-center">
                        <div>
                            <div class="fw-bold fs-5 {% if waiting_for_repair > 0 %}text-danger{% else %}text-dark{% endif %}">
                                {{ waiting_for_repair }}
                            </div>
                            <small class="text-muted" style="font-size: 0.7rem; display: block; line-height: 1.1;">–û—á—ñ–∫—É—é—Ç—å</small>
                        </div>
                        <div class="vr bg-secondary opacity-25"></div>
                        <div>
                            <div class="fw-bold fs-5 text-primary">
                                {{ in_repair_process }}
                            </div>
                            <small class="text-muted" style="font-size: 0.7rem; display: block; line-height: 1.1;">–í —Ä–æ–±–æ—Ç—ñ</small>
                        </div>
                        <div class="vr bg-secondary opacity-25"></div>
                        <div>
                            <div class="fw-bold fs-5 text-success">
                                {{ ready_on_stock }}
                            </div>
                            <small class="text-muted" style="font-size: 0.7rem; display: block; line-height: 1.1;">–°–∫–ª–∞–¥</small>
                        </div>
                    </div>

                    <a href="/service/" class="stretched-link"></a>
                </div>
            </div>
        </div>

        <div class="col">
            <div class="card h-100 border-0 shadow-sm hover-lift position-relative">
                <div class="card-body p-4">
                    <div class="d-flex align-items-center mb-3">
                        <div class="icon-square bg-purple-subtle me-3">
                            <i class="bi bi-people-fill"></i>
                        </div>
                        <div>
                            <h5 class="card-title fw-bold mb-0">–ü–µ—Ä—Å–æ–Ω–∞–ª</h5>
                            <span class="text-muted small">–®—Ç–∞—Ç–Ω–∏–π —Ä–æ–∑–ø–∏—Å</span>
                        </div>
                    </div>

                    <div class="mt-3">
                        <div class="stat-value">{{ employees_count }}</div>
                        <div class="stat-label">–ø—Ä–∞—Ü—ñ–≤–Ω–∏–∫—ñ–≤</div>
                    </div>

                    <a href="{% url 'staff_list' %}" class="stretched-link"></a>
                </div>
            </div>
        </div>

        <div class="col">
            <div class="card h-100 border-0 shadow-sm hover-lift position-relative">
                <div class="card-body p-4 d-flex align-items-center">
                    <div class="icon-square bg-gray-subtle me-3">
                        <i class="bi bi-archive"></i>
                    </div>
                    <div>
                        <h6 class="card-title fw-bold mb-1">–ê—Ä—Ö—ñ–≤ –∞–∫—Ç—ñ–≤</h6>
                        <p class="text-muted small mb-0">–Ü—Å—Ç–æ—Ä—ñ—è –ø–µ—Ä–µ–¥–∞—á—ñ —Ç–µ—Ö–Ω—ñ–∫–∏</p>
                    </div>
                    <a href="/service/reports/" class="stretched-link"></a>
                    <i class="bi bi-chevron-right ms-auto text-muted small"></i>
                </div>
            </div>
        </div>

        <div class="col">
            <div class="card h-100 border-0 shadow-sm hover-lift position-relative">
                <div class="card-body p-4 d-flex align-items-center">
                    <div class="icon-square bg-teal-subtle me-3">
                        <i class="bi bi-journal-bookmark-fill"></i>
                    </div>
                    <div>
                        <h6 class="card-title fw-bold mb-1">–î–æ–≤—ñ–¥–Ω–∏–∫</h6>
                        <p class="text-muted small mb-0">–ö–æ–Ω—Ç–∞–∫—Ç–∏ —Ç–∞ –≤—ñ–¥–¥—ñ–ª–∏</p>
                    </div>
                    <a href="{% url 'directory_list' %}" class="stretched-link"></a>
                    <i class="bi bi-chevron-right ms-auto text-muted small"></i>
                </div>
            </div>
        </div>

        <div class="col">
            <div class="card h-100 border-0 shadow-sm hover-lift position-relative">
                <div class="card-body p-4 d-flex align-items-center">
                    <div class="icon-square bg-green-subtle me-3">
                        <i class="bi bi-folder2-open"></i>
                    </div>
                    <div>
                        <h6 class="card-title fw-bold mb-1">–§–∞–π–ª–∏</h6>
                        <p class="text-muted small mb-0">–Ü–Ω—Å—Ç—Ä—É–∫—Ü—ñ—ó —Ç–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∏</p>
                    </div>
                    <a href="/docs/" class="stretched-link"></a>
                    <i class="bi bi-chevron-right ms-auto text-muted small"></i>
                </div>
            </div>
        </div>

    </div>
</div>
<div id="secret-match3-wrapper">
    <div class="m3g-overlay" id="m3g-overlay">
        <div class="m3g-container">
            <button class="m3g-close-btn" id="m3g-close">√ó</button>
            <h2 class="m3g-title">–¢—Ä–∏ –≤ —Ä—è–¥</h2>

            <div class="m3g-stats">
                <div class="m3g-stat-box">–†–∞—Ö—É–Ω–æ–∫: <span id="m3g-score">0</span> / 250</div>
                <div class="m3g-stat-box">–ß–∞—Å: <span id="m3g-timer">120</span> —Å–µ–∫</div>
            </div>

            <div id="m3g-message" class="m3g-msg">–•–û–î–Ü–í –ù–ï–ú–ê–Ñ! –ü–ï–†–ï–ú–Ü–®–£–Æ...</div>

            <div class="m3g-grid" id="m3g-grid"></div>
        </div>
    </div>
</div>

<script>
    (function() {
       const secretCodes = ['—á—É–¥–æ', 'xelj'];
        let inputBuffer = '';

        // --- –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è ---
        const width = 8;
        const totalCells = width * width; // 64
        const targetScore = 250;
        const initialTime = 120;
        const candyColors = ['üçé', 'üçä', 'üçá', 'ü••', 'ü•ù', 'üç™'];

        // --- –°—Ç–∞–Ω –≥—Ä–∏ ---
        let score = 0;
        let timeLeft = initialTime;
        let squares = [];
        let selectedSquareIndex = null;

        let isProcessingMove = false;
        let isShuffling = false;

        let timerId = null;
        let gameLoopId = null;
        let shuffleCheckId = null;

        // –ï–ª–µ–º–µ–Ω—Ç–∏ DOM
        const overlay = document.getElementById('m3g-overlay');
        const gridDisplay = document.getElementById('m3g-grid');
        const scoreDisplay = document.getElementById('m3g-score');
        const timerDisplay = document.getElementById('m3g-timer');
        const closeBtn = document.getElementById('m3g-close');
        const messageDisplay = document.getElementById('m3g-message');

        // --- 1. –í–í–ï–î–ï–ù–ù–Ø –ö–û–î–£ ---
        document.addEventListener('keydown', (e) => {
            inputBuffer += e.key;
            if (inputBuffer.length > secretCode.length) inputBuffer = inputBuffer.slice(-secretCode.length);
            if (inputBuffer.toLowerCase() === secretCode) {
                openGame();
                inputBuffer = '';
            }
        });

        closeBtn.addEventListener('click', closeGame);

        function openGame() {
            overlay.style.display = 'flex';
            resetGame();
        }

        function closeGame() {
            overlay.style.display = 'none';
            stopAllLoops();
        }

        function stopAllLoops() {
            clearInterval(timerId);
            clearInterval(gameLoopId);
            clearInterval(shuffleCheckId);
        }

        function resetGame() {
            stopAllLoops();
            gridDisplay.innerHTML = '';
            squares = [];
            score = 0;
            timeLeft = initialTime;
            selectedSquareIndex = null;
            isProcessingMove = false;
            isShuffling = false;
            messageDisplay.style.display = 'none';

            scoreDisplay.innerText = score;
            timerDisplay.innerText = timeLeft;

            createBoard();

            timerId = setInterval(() => {
                timeLeft--;
                timerDisplay.innerText = timeLeft;
                if (timeLeft <= 0) endGame(false);
            }, 1000);

            // –û—Å–Ω–æ–≤–Ω–∏–π —Ü–∏–∫–ª: –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ 5, –ø–æ—Ç—ñ–º 4, –ø–æ—Ç—ñ–º 3
            gameLoopId = setInterval(() => {
                if (!isShuffling && !isProcessingMove) {
                    checkLinearMatch(5, 10);
                    checkLinearMatch(4, 5);
                    checkLinearMatch(3, 3);
                    moveDown();
                    checkWin();
                }
            }, 100);

            // –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –Ω–∞ –≤—ñ–¥—Å—É—Ç–Ω—ñ—Å—Ç—å —Ö–æ–¥—ñ–≤
            shuffleCheckId = setInterval(() => {
                if (!isShuffling && !isProcessingMove && isBoardStable() && !hasPossibleMoves()) {
                    shuffleBoard();
                }
            }, 1500);
        }

        function endGame(isWin) {
            stopAllLoops();
            setTimeout(() => {
                if (isWin) alert(`üéâ –ü–µ—Ä–µ–º–æ–≥–∞! –í–∏ –Ω–∞–±—Ä–∞–ª–∏ ${score} –æ—á–æ–∫!`);
                else alert(`‚è∞ –ß–∞—Å –≤–∏–π—à–æ–≤! –í–∞—à —Ä–∞—Ö—É–Ω–æ–∫: ${score}`);
                closeGame();
            }, 100);
        }

        function checkWin() {
            if (score >= targetScore) endGame(true);
        }

        function createBoard() {
            for (let i = 0; i < totalCells; i++) {
                const square = document.createElement('div');
                square.classList.add('m3g-cell');
                square.setAttribute('id', i);
                let randomColor = Math.floor(Math.random() * candyColors.length);
                square.innerText = candyColors[randomColor];
                gridDisplay.appendChild(square);
                squares.push(square);
                square.addEventListener('click', () => clickItem(i));
            }
        }

        function clickItem(index) {
            if (isShuffling || isProcessingMove || !isBoardStable()) return;

            if (index === selectedSquareIndex) {
                squares[index].classList.remove('selected');
                selectedSquareIndex = null;
                return;
            }

            if (selectedSquareIndex === null) {
                selectedSquareIndex = index;
                squares[index].classList.add('selected');
            } else {
                squares[selectedSquareIndex].classList.remove('selected');

                let validMoves = [
                    selectedSquareIndex - 1, selectedSquareIndex - width,
                    selectedSquareIndex + 1, selectedSquareIndex + width
                ];

                const isRightEdge = (selectedSquareIndex % width) === width - 1;
                const isLeftEdge = (selectedSquareIndex % width) === 0;
                if (index === selectedSquareIndex + 1 && isRightEdge) { selectedSquareIndex = null; return; }
                if (index === selectedSquareIndex - 1 && isLeftEdge) { selectedSquareIndex = null; return; }

                if (validMoves.includes(index)) {
                    isProcessingMove = true;
                    swapColors(selectedSquareIndex, index);

                    const isMoveValid = checkForMatchesPreview();

                    if (isMoveValid) {
                        isProcessingMove = false;
                        selectedSquareIndex = null;
                    } else {
                        squares[selectedSquareIndex].classList.add('shake');
                        squares[index].classList.add('shake');

                        setTimeout(() => {
                            swapColors(selectedSquareIndex, index);
                            squares[selectedSquareIndex].classList.remove('shake');
                            squares[index].classList.remove('shake');
                            isProcessingMove = false;
                            selectedSquareIndex = null;
                        }, 250);
                    }
                } else {
                    selectedSquareIndex = index;
                    squares[index].classList.add('selected');
                }
            }
        }

        function swapColors(index1, index2) {
            let temp = squares[index1].innerText;
            squares[index1].innerText = squares[index2].innerText;
            squares[index2].innerText = temp;
        }

        function isBoardStable() {
            return squares.every(sq => sq.innerText !== '');
        }

        // --- –í–ò–ü–†–ê–í–õ–ï–ù–ê –§–£–ù–ö–¶–Ü–Ø –í–ê–õ–Ü–î–ê–¶–Ü–á ---
        function checkForMatchesPreview() {
            // –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ —Ä—è–¥–∫—ñ–≤
            for (let i = 0; i < 64; i++) {
                let rowOfThree = [i, i + 1, i + 2];
                let decidedColor = squares[i].innerText;
                const isBlank = squares[i].innerText === '';
                if (i % width > width - 3) continue;
                if (rowOfThree.every(index => squares[index].innerText === decidedColor && !isBlank)) return true;
            }
            // –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –∫–æ–ª–æ–Ω–æ–∫
            // –¢–£–¢ –ë–£–õ–ê –ü–û–ú–ò–õ–ö–ê: –±—É–ª–æ i < 47, —Ç–µ–ø–µ—Ä i < 48 (–∞–±–æ –ø—Ä–æ—Å—Ç–æ <= 47)
            // –¶–µ –¥–æ–∑–≤–æ–ª—è—î –ø–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ —ñ–Ω–¥–µ–∫—Å 47 (–ø–æ—á–∞—Ç–æ–∫ –æ—Å—Ç–∞–Ω–Ω—å–æ—ó –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω–æ—ó —Ç—Ä—ñ–π–∫–∏: 47-55-63)
            for (let i = 0; i < 48; i++) {
                let columnOfThree = [i, i + width, i + width * 2];
                let decidedColor = squares[i].innerText;
                const isBlank = squares[i].innerText === '';
                if (columnOfThree.every(index => squares[index].innerText === decidedColor && !isBlank)) return true;
            }
            return false;
        }

        function hasPossibleMoves() {
            for (let i = 0; i < 64; i++) {
                if ((i % width) < width - 1) {
                    swapColors(i, i + 1);
                    if (checkForMatchesPreview()) { swapColors(i, i + 1); return true; }
                    swapColors(i, i + 1);
                }
                if (i < 56) {
                    swapColors(i, i + width);
                    if (checkForMatchesPreview()) { swapColors(i, i + width); return true; }
                    swapColors(i, i + width);
                }
            }
            return false;
        }

        function shuffleBoard() {
            isShuffling = true;
            messageDisplay.style.display = 'block';
            setTimeout(() => {
                let allColors = squares.map(sq => sq.innerText);
                for (let i = allColors.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [allColors[i], allColors[j]] = [allColors[j], allColors[i]];
                }
                squares.forEach((sq, i) => sq.innerText = allColors[i]);
                messageDisplay.style.display = 'none';
                isShuffling = false;
            }, 1000);
        }

        // --- –£–ù–Ü–í–ï–†–°–ê–õ–¨–ù–ê –§–£–ù–ö–¶–Ü–Ø (–í–ò–î–ê–õ–ï–ù–ù–Ø) ---
        function checkLinearMatch(length, points) {
            // –†—è–¥–∫–∏
            for (let i = 0; i < 64; i++) {
                if (i % width > width - length) continue;
                let rowGroup = [];
                for(let k=0; k<length; k++) rowGroup.push(i + k);

                let decidedColor = squares[i].innerText;
                const isBlank = squares[i].innerText === '';
                if (!isBlank && rowGroup.every(index => squares[index].innerText === decidedColor)) {
                    score += points;
                    scoreDisplay.innerText = score;
                    rowGroup.forEach(index => squares[index].innerText = '');
                }
            }

            // –ö–æ–ª–æ–Ω–∫–∏
            for (let i = 0; i < 64; i++) {
                if (i + (length - 1) * width >= 64) continue;
                let colGroup = [];
                for(let k=0; k<length; k++) colGroup.push(i + k * width);

                let decidedColor = squares[i].innerText;
                const isBlank = squares[i].innerText === '';
                if (!isBlank && colGroup.every(index => squares[index].innerText === decidedColor)) {
                    score += points;
                    scoreDisplay.innerText = score;
                    colGroup.forEach(index => squares[index].innerText = '');
                }
            }
        }

        function moveDown() {
            for (let i = 0; i < 56; i++) {
                if (squares[i + width].innerText === '') {
                    squares[i + width].innerText = squares[i].innerText;
                    squares[i].innerText = '';
                    const firstRow = [0, 1, 2, 3, 4, 5, 6, 7];
                    const isFirstRow = firstRow.includes(i);
                    if (isFirstRow && squares[i].innerText === '') {
                        let randomColor = Math.floor(Math.random() * candyColors.length);
                        squares[i].innerText = candyColors[randomColor];
                    }
                }
            }
            for (let i = 0; i < width; i++) {
                if(squares[i].innerText === '') {
                   let randomColor = Math.floor(Math.random() * candyColors.length);
                   squares[i].innerText = candyColors[randomColor];
                }
            }
        }
    })();
</script>

{% endblock %}