{% extends 'base.html' %}

{% block content %}
<style>
    @media (max-width: 768px) {
        .mobile-table thead { display: none; }
        .mobile-table, .mobile-table tbody, .mobile-table tr, .mobile-table td {
            display: block; width: 100%;
        }
        .mobile-table tr {
            margin-bottom: 15px; background: #fff; border: 1px solid #ddd;
            border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); padding: 15px;
        }
        .mobile-table td {
            text-align: right; padding-left: 45%; position: relative;
            border-bottom: 1px solid #f0f0f0; padding-top: 10px; padding-bottom: 10px;
            min-height: 40px;
        }
        .mobile-table td:last-child {
            border-bottom: 0; justify-content: flex-end; padding-top: 15px; display: flex; gap: 10px;
        }
        .mobile-table td::before {
            content: attr(data-label); position: absolute; left: 0; width: 40%;
            padding-left: 0; font-weight: 600; text-align: left; color: #6c757d; font-size: 0.9em; text-transform: uppercase;
        }
    }
    .animation-fade-in { animation: fadeIn 0.5s; }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
</style>

<div class="row justify-content-center">
    <div class="col-md-12">
        <div class="card shadow-sm border-0 bg-transparent">

            <div class="card-header bg-white py-3 rounded-3 shadow-sm mb-3">
                <div class="d-flex flex-column flex-md-row justify-content-between align-items-center gap-3">
                    <h4 class="mb-0 text-primary"><i class="bi bi-tools"></i> Журнал сервісу</h4>
                    <div class="d-flex gap-2 w-100 w-md-auto justify-content-md-end">
                        <a href="{% url 'report_list' %}" class="btn btn-outline-secondary flex-fill flex-md-grow-0 text-nowrap">
                            <i class="bi bi-clock-history"></i> Історія актів
                        </a>
                        <a href="{% url 'service_create' %}" class="btn btn-warning flex-fill flex-md-grow-0 text-nowrap">
                            <i class="bi bi-plus-lg"></i> Нова заявка
                        </a>
                    </div>
                </div>
            </div>

            <div class="card mb-3 border-primary border-opacity-25 shadow-sm">
                <div class="card-body d-flex flex-column flex-md-row justify-content-between align-items-center gap-3">
                    <div>
                        <h5 class="card-title text-primary mb-1">Відправка в сервіс</h5>
                        <p class="card-text text-muted small mb-0">Натисніть кнопку, щоб переглянути список на відправку та створити акт.</p>
                    </div>
                    <div class="w-100 w-md-auto">
                        <a href="{% url 'print_preview' %}" class="btn btn-primary w-100">
                            <i class="bi bi-eye"></i> Переглянути та сформувати акт
                        </a>
                    </div>
                </div>
            </div>

            <div class="card shadow-sm mb-3 border-0">
                <div class="card-body p-2 d-flex flex-column flex-md-row gap-2 bg-white rounded-3">
                    <div class="btn-group w-100 w-md-auto" role="group" id="filter-buttons">
                        <a href="?filter=all{% if search_query %}&q={{ search_query }}{% endif %}"
                           class="btn btn-outline-primary filter-link {% if current_filter == 'all' %}active{% endif %}" data-filter="all">Всі</a>

                        <a href="?filter=active{% if search_query %}&q={{ search_query }}{% endif %}"
                           class="btn btn-outline-primary filter-link {% if current_filter == 'active' %}active{% endif %}" data-filter="active">В роботі</a>

                        <a href="?filter=completed{% if search_query %}&q={{ search_query }}{% endif %}"
                           class="btn btn-outline-primary filter-link {% if current_filter == 'completed' %}active{% endif %}" data-filter="completed">Архів</a>
                    </div>
                    <div class="input-group">
                        <span class="input-group-text bg-light border-end-0"><i class="bi bi-search"></i></span>
                        <input type="text" id="service-search" value="{{ search_query }}" class="form-control border-start-0 bg-light" placeholder="Пошук картриджа, відділу...">
                    </div>
                </div>
            </div>

            <div class="card-body p-0 bg-transparent">
                <div id="service-table-container">
                <table class="table table-hover align-middle mb-0 mobile-table bg-white rounded-3 shadow-sm" style="table-layout: fixed;">
                    <thead class="table-light text-secondary">
                        <tr>
                            <th class="ps-4" style="width: 5%; white-space: nowrap;">Статус</th>
                            <th scope="col" style="width: 55%;">Список робіт / Пристрої</th>
                            <th style="width: 20%;">Від кого</th>
                            <th style="width: 15%;">Дати</th>
                            <th class="text-end pe-4" style="width: 5%;">Дії</th>
                        </tr>
                    </thead>
                    <tbody id="table-body">
                        {% for task in tasks %}
                        <tr class="service-row">
                            <td class="ps-4 align-top pt-3" data-label="Статус">
                                {% if task.is_completed %}
                                    <span class="badge bg-success rounded-pill" title="Заявка закрита"><i class="bi bi-check-all"></i></span>
                                {% elif task.date_sent %}
                                    <span class="badge bg-primary rounded-pill" title="В роботі"><i class="bi bi-tools"></i></span>
                                {% else %}
                                    <span class="badge bg-secondary rounded-pill" title="Нова"><i class="bi bi-hourglass-split"></i></span>
                                {% endif %}
                            </td>

                            <td class="align-top p-2">
                                {% if task.items.exists %}
                                    <div class="list-group list-group-flush">
                                        {% for item in task.items.all %}
                                           <div class="list-group-item d-flex flex-column flex-sm-row justify-content-between align-items-start align-items-sm-center border-0 py-2 px-0">

        <div class="d-flex align-items-center mb-2 mb-sm-0 me-3">
            <i class="bi bi-dot text-secondary fs-5 me-1"></i>
            <div style="line-height: 1.2;">
                {% if item.item_name == 'Інше' %}
                    <span class="fw-bold text-dark search-target">{{ item.custom_name }}</span>
                {% else %}
                    <span class="fw-bold text-dark search-target">{{ item.get_item_name_display }}</span>
                {% endif %}

                {% if item.note %}
                    <div class="small text-muted fst-italic mt-1 search-target" style="font-size: 0.9em;">
                        <i class="bi bi-chat-left-text text-secondary opacity-75 me-1"></i> {{ item.note }}
                    </div>
                {% endif %}
                <div class="mt-1">
                    <span class="badge bg-light text-dark border">{{ item.quantity }} шт.</span>
                </div>
            </div>
        </div>

                                                <div style="width: 160px; flex-shrink: 0;" id="action-block-{{ item.pk }}">
                                                    {% if not item.date_back_from_service %}
                                                        {% if task.date_sent %}
                                                            <a href="#"
                                                               data-url="{% url 'item_receive' item.pk %}"
                                                               data-qty="{{ item.quantity }}"
                                                               class="btn btn-sm btn-outline-success w-100 d-flex justify-content-center align-items-center gap-2 ajax-btn receive-btn">
                                                                <i class="bi bi-box-seam"></i> Отримати
                                                            </a>
                                                        {% else %}
                                                            <div class="text-center text-muted small border rounded bg-light py-1"><i class="bi bi-clock"></i> Очікує</div>
                                                        {% endif %}
                                                    {% elif not item.date_returned_to_user %}
                                                        <div class="d-flex flex-column gap-1">
                                                            <span class="badge bg-info text-dark w-100">На складі</span>
                                                            <a href="#" data-url="{% url 'item_return' item.pk %}"
                                                               class="btn btn-sm btn-primary w-100 py-0 ajax-btn return-btn" style="font-size: 0.85rem;">
                                                                Видати <i class="bi bi-arrow-right"></i>
                                                            </a>
                                                        </div>
                                                    {% else %}
                                                        <div class="text-end text-success small">
                                                            <i class="bi bi-check-all fs-5"></i>
                                                            <div>Видано {{ item.date_returned_to_user|date:"d.m" }}</div>
                                                        </div>
                                                    {% endif %}
                                                </div>
                                            </div>
                                            {% if not forloop.last %}<hr class="my-1 text-muted opacity-25">{% endif %}
                                        {% endfor %}
                                    </div>
                                {% else %}
                                    <div class="text-muted fst-italic p-2 search-target">{{ task.description|default:"Опис відсутній" }}</div>
                                {% endif %}
                            </td>

                            <td class="align-top pt-3" data-label="Від кого">
                                <div class="fw-bold text-dark text-wrap search-target" style="line-height: 1.3;">{{ task.department }}</div>
                                <div class="small text-muted search-target mt-1">{{ task.requester_name }}</div>
                            </td>

                            <td class="align-top pt-3" data-label="Дати">
                                <div class="d-flex flex-column gap-1 small">
                                    <div class="d-flex justify-content-between"><span class="text-muted">Ство:</span> <strong>{{ task.date_received|date:"d.m" }}</strong></div>
                                    {% if task.date_sent %}
                                    <div class="d-flex justify-content-between"><span class="text-primary">Акт:</span> <strong>{{ task.date_sent|date:"d.m" }}</strong></div>
                                    {% endif %}
                                </div>
                            </td>

                            <td class="align-top text-end pe-4 pt-3" data-label="Дії">
                                <a href="{% url 'service_update' task.pk %}" class="btn btn-light btn-sm border text-secondary" title="Редагувати"><i class="bi bi-pencil"></i></a>
                            </td>
                        </tr>
                        {% empty %}
                        <tr><td colspan="5" class="text-center py-5 text-muted">Заявок поки немає (або нічого не знайдено).</td></tr>
                        {% endfor %}
                    </tbody>
                </table>
                </div>
            </div>

            <div class="card-footer bg-white border-top-0 py-3 rounded-3 shadow-sm mt-3" id="pagination-container">
                <div class="d-flex justify-content-between align-items-center flex-column flex-md-row gap-2">
                    <small class="text-muted">
                        Всього заявок: <strong>{{ total_count }}</strong>.
                        Сторінка {{ tasks.number }} з {{ tasks.paginator.num_pages }}.
                    </small>

                    {% if tasks.paginator.num_pages > 1 %}
                    <nav>
                        <ul class="pagination pagination-sm mb-0">
                            {% if tasks.has_previous %}
                                <li class="page-item">
                                    <a class="page-link" href="?page={{ tasks.previous_page_number }}&filter={{ current_filter }}{% if search_query %}&q={{ search_query }}{% endif %}">
                                        <i class="bi bi-chevron-left"></i>
                                    </a>
                                </li>
                            {% else %}
                                <li class="page-item disabled"><span class="page-link"><i class="bi bi-chevron-left"></i></span></li>
                            {% endif %}

                            {% for i in tasks.paginator.page_range %}
                                {% if tasks.number == i %}
                                    <li class="page-item active"><span class="page-link">{{ i }}</span></li>
                                {% elif i > tasks.number|add:'-3' and i < tasks.number|add:'3' %}
                                    <li class="page-item">
                                        <a class="page-link" href="?page={{ i }}&filter={{ current_filter }}{% if search_query %}&q={{ search_query }}{% endif %}">{{ i }}</a>
                                    </li>
                                {% endif %}
                            {% endfor %}

                            {% if tasks.has_next %}
                                <li class="page-item">
                                    <a class="page-link" href="?page={{ tasks.next_page_number }}&filter={{ current_filter }}{% if search_query %}&q={{ search_query }}{% endif %}">
                                        <i class="bi bi-chevron-right"></i>
                                    </a>
                                </li>
                            {% else %}
                                <li class="page-item disabled"><span class="page-link"><i class="bi bi-chevron-right"></i></span></li>
                            {% endif %}
                        </ul>
                    </nav>
                    {% endif %}
                </div>
            </div>

        </div>
    </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", function() {
    const searchInput = document.getElementById('service-search');
    const tableBody = document.getElementById('table-body');
    const paginationContainer = document.getElementById('pagination-container');
    const tableContainer = document.getElementById('service-table-container');
    let debounceTimer;

    // --- УНІВЕРСАЛЬНА ФУНКЦІЯ ЗАВАНТАЖЕННЯ (AJAX) ---
    function loadTableData(url) {
        if(tableContainer) tableContainer.style.opacity = '0.5';

        fetch(url, {
            headers: { 'X-Requested-With': 'XMLHttpRequest' }
        })
        .then(response => response.text())
        .then(html => {
            const parser = new DOMParser();
            const doc = parser.parseFromString(html, 'text/html');

            const newTableBody = doc.getElementById('table-body').innerHTML;
            tableBody.innerHTML = newTableBody;

            const newPagination = doc.getElementById('pagination-container');
            if (newPagination && paginationContainer) {
                paginationContainer.innerHTML = newPagination.innerHTML;
            }

            // Оновлюємо кнопки фільтрів
            const currentUrlParams = new URLSearchParams(url.split('?')[1]);
            const newFilter = currentUrlParams.get('filter') || 'active';
            document.querySelectorAll('.filter-link').forEach(btn => {
                btn.classList.remove('active');
                if (btn.dataset.filter === newFilter) btn.classList.add('active');
            });

            // Оновлюємо URL без перезавантаження
            window.history.pushState({path: url}, '', url);

            if(tableContainer) tableContainer.style.opacity = '1';
        })
        .catch(err => {
            console.error('Помилка:', err);
            if(tableContainer) tableContainer.style.opacity = '1';
        });
    }

    // --- ПЕРЕХОПЛЕННЯ КЛІКІВ (Вкладки та Пагінація) ---
    document.addEventListener('click', function(e) {
        const link = e.target.closest('.page-link, .filter-link');

        // Перевіряємо, чи це посилання і чи не заблоковане
        if (link && link.getAttribute('href') && !link.parentElement.classList.contains('disabled')) {
            if (link.tagName.toLowerCase() === 'a') {
                e.preventDefault(); // <--- ОСЬ ЦЕ БЛОКУЄ ПЕРЕЗАВАНТАЖЕННЯ
                loadTableData(link.getAttribute('href'));
            }
        }
    });

    if (searchInput) {
        searchInput.addEventListener('keyup', function() {
            clearTimeout(debounceTimer);
            const query = this.value.trim();
            const urlParams = new URLSearchParams(window.location.search);
            const filter = urlParams.get('filter') || 'active';

            debounceTimer = setTimeout(() => {
                const newUrl = `${window.location.pathname}?q=${encodeURIComponent(query)}&filter=${filter}`;
                loadTableData(newUrl);
            }, 300);
        });
    }

    // --- AJAX ДЛЯ КНОПОК ---
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    const csrftoken = getCookie('csrftoken');

    document.body.addEventListener('click', function(e) {
        const btn = e.target.closest('.ajax-btn');
        if (btn) {
            e.preventDefault();

            let url = btn.getAttribute('data-url');
            const isReceiveBtn = url.includes('receive');
            let quantity = parseInt(btn.getAttribute('data-qty') || 1);
            let qtyToReceive = quantity;

            if (isReceiveBtn && quantity > 1) {
                let input = prompt(`Всього у заявці: ${quantity} шт.\nСкільки повернулось з ремонту?`, quantity);
                if (input === null) return;
                qtyToReceive = parseInt(input);
                if (isNaN(qtyToReceive) || qtyToReceive <= 0 || qtyToReceive > quantity) {
                    alert("Некоректна кількість!");
                    return;
                }
                url += `?qty=${qtyToReceive}`;
            }

            const container = btn.closest('div[id^="action-block-"]');
            const originalContent = btn.innerHTML;
            btn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> ...';
            btn.classList.add('disabled');

            fetch(url, {
                method: 'GET',
                headers: { 'X-Requested-With': 'XMLHttpRequest', 'X-CSRFToken': csrftoken }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    if (data.is_split) {
                        window.location.reload();
                    } else {
                        if (data.new_state === 'stocked') {
                            container.innerHTML = `<div class="d-flex flex-column gap-1 animation-fade-in"><span class="badge bg-info text-dark w-100">На складі</span><a href="#" data-url="${data.return_url}" class="btn btn-sm btn-primary w-100 py-0 ajax-btn return-btn" style="font-size: 0.85rem;">Видати <i class="bi bi-arrow-right"></i></a></div>`;
                        } else if (data.new_state === 'issued') {
                            container.innerHTML = `<div class="text-end text-success small animation-fade-in"><i class="bi bi-check-all fs-5"></i> <div>Видано ${data.date_str}</div></div>`;
                            if (data.task_completed) {
                                const row = container.closest('tr');
                                if (row) {
                                    row.setAttribute('data-status', 'completed');
                                    const statusCell = row.querySelector('td:first-child');
                                    if (statusCell) statusCell.innerHTML = '<span class="badge bg-success rounded-pill" title="Заявка закрита"><i class="bi bi-check-all"></i></span>';
                                }
                            }
                        }
                    }
                } else {
                    alert('Помилка сервера.');
                    btn.innerHTML = originalContent;
                    btn.classList.remove('disabled');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                btn.innerHTML = originalContent;
                btn.classList.remove('disabled');
            });
        }
    });
});
</script>
{% endblock %}