{% extends 'base.html' %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2>üõ†Ô∏è –ñ—É—Ä–Ω–∞–ª —Å–µ—Ä–≤—ñ—Å—É</h2>
    <div>
        <a href="{% url 'report_list' %}" class="btn btn-outline-secondary me-2"><i class="bi bi-clock-history"></i> –Ü—Å—Ç–æ—Ä—ñ—è –∞–∫—Ç—ñ–≤</a>

        <a href="{% url 'service_create' %}" class="btn btn-warning"><i class="bi bi-plus-lg"></i> –ù–æ–≤–∞ –∑–∞—è–≤–∫–∞</a>
    </div>
</div>

<div class="card mb-4 border-primary">
    <div class="card-body d-flex justify-content-between align-items-center bg-light">
        <div>
            <h5 class="mb-0">–í—ñ–¥–ø—Ä–∞–≤–∫–∞ –≤ —Å–µ—Ä–≤—ñ—Å</h5>
            <small class="text-muted">–ù–∞—Ç–∏—Å–Ω—ñ—Ç—å –∫–Ω–æ–ø–∫—É, —â–æ–± –∑—ñ–±—Ä–∞—Ç–∏ –≤—Å—ñ –Ω–µ–≤—ñ–¥–ø—Ä–∞–≤–ª–µ–Ω—ñ –∫–∞—Ä—Ç—Ä–∏–¥–∂—ñ –≤ –æ–¥–∏–Ω –∞–∫—Ç.</small>
        </div>
        <a href="{% url 'print_preview' %}" class="btn btn-primary"><i class="bi bi-printer"></i> –°—Ñ–æ—Ä–º—É–≤–∞—Ç–∏ –Ω–æ–≤–∏–π –∞–∫—Ç</a>
    </div>
</div>

<div class="card">
    <div class="table-responsive">
        <table class="table table-hover mb-0 align-middle">
            <thead class="table-dark">
                <tr>
                    <th>–°—Ç–∞—Ç—É—Å</th>
                    <th>–ü—Ä–∏—Å—Ç—Ä—ñ–π</th>
                    <th>–í—ñ–¥ –∫–æ–≥–æ</th>
                    <th>–î–∞—Ç–∏ (–û—Ç—Ä / –í—ñ–¥–ø—Ä / –ü–æ–≤)</th>
                    <th class="text-end">–î—ñ—ó</th>
                </tr>
            </thead>
           <tbody>
    {% for task in tasks %}
    <tr>
        <td>
            {% if task.is_completed %}
                <span class="badge bg-success"><i class="bi bi-check-circle"></i> –í–∏–¥–∞–Ω–æ</span>
            {% elif task.date_back_from_service %}
                <span class="badge bg-warning text-dark"><i class="bi bi-box-seam"></i> –ù–∞ —Å–∫–ª–∞–¥—ñ</span>
            {% elif task.date_sent %}
                <span class="badge bg-primary"><i class="bi bi-tools"></i> –í —Ä–µ–º–æ–Ω—Ç—ñ</span>
            {% else %}
                <span class="badge bg-danger">–û—á—ñ–∫—É—î</span>
            {% endif %}
        </td>
        <td class="fw-bold">{{ task.device_name }}</td>
        <td>
            {{ task.department }}<br>
            <small class="text-muted">{{ task.requester_name }}</small>
        </td>
        <td style="font-size: 0.9em;">
            üì• {{ task.date_received|date:"d.m" }}<br>
            üöö {{ task.date_sent|date:"d.m"|default:"-" }}<br>
            üîô {{ task.date_back_from_service|date:"d.m"|default:"-" }} </td>
        <td class="text-end">
            {% if not task.is_completed %}

                {% if task.date_sent and not task.date_back_from_service %}
                    <a href="{% url 'service_receive_from_repair' task.pk %}" class="btn btn-sm btn-info me-1" title="–ü—Ä–∏–π—à–ª–æ –∑ —Ä–µ–º–æ–Ω—Ç—É">
                        üì¶ –û—Ç—Ä–∏–º–∞—Ç–∏
                    </a>
                {% endif %}

                {% if task.date_back_from_service %}
                    <a href="{% url 'service_quick_return' task.pk %}" class="btn btn-sm btn-success me-1" title="–í—ñ–¥–¥–∞—Ç–∏ –∫–ª—ñ—î–Ω—Ç—É">
                        ‚úÖ –í—ñ–¥–¥–∞—Ç–∏
                    </a>
                {% endif %}

            {% endif %}

            <a href="{% url 'service_update' task.pk %}" class="btn btn-sm btn-outline-primary"><i class="bi bi-pencil"></i></a>
        </td>
    </tr>
    {% empty %}
    <tr>
        <td colspan="5" class="text-center py-4">–ñ—É—Ä–Ω–∞–ª –ø—É—Å—Ç–∏–π</td>
    </tr>
    {% endfor %}
</tbody>
        </table>
    </div>
</div>
<script>
document.addEventListener("DOMContentLoaded", function() {
    // 1. –°—Ç–≤–æ—Ä—é—î–º–æ –ø–æ–ª–µ –ø–æ—à—É–∫—É –¥–∏–Ω–∞–º—ñ—á–Ω–æ, –∞–±–æ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ —ñ—Å–Ω—É—é—á–µ —è–∫—â–æ —î
    // –î–∞–≤–∞–π—Ç–µ –¥–æ–¥–∞–º–æ –ø–æ–ª–µ –ø–æ—à—É–∫—É –ø—Ä—è–º–æ –Ω–∞–¥ —Ç–∞–±–ª–∏—Ü–µ—é
    const tableCard = document.querySelector('.table-responsive').parentNode;

    const searchInput = document.createElement('input');
    searchInput.type = 'text';
    searchInput.placeholder = 'üîç –®–≤–∏–¥–∫–∏–π –ø–æ—à—É–∫ –ø–æ —Å—Ç–æ—Ä—ñ–Ω—Ü—ñ...';
    searchInput.className = 'form-control mb-3';
    searchInput.style.maxWidth = '300px';

    // –í—Å—Ç–∞–≤–ª—è—î–º–æ –ø–æ–ª–µ –ø–µ—Ä–µ–¥ —Ç–∞–±–ª–∏—Ü–µ—é
    tableCard.insertBefore(searchInput, tableCard.firstChild);

    // 2. –õ–æ–≥—ñ–∫–∞ —Ñ—ñ–ª—å—Ç—Ä–∞—Ü—ñ—ó
    searchInput.addEventListener('keyup', function() {
        const filter = searchInput.value.toLowerCase();
        const rows = document.querySelectorAll('tbody tr');

        rows.forEach(row => {
            const text = row.textContent.toLowerCase();
            if (text.includes(filter)) {
                row.style.display = '';
            } else {
                row.style.display = 'none';
            }
        });
    });
});
</script>
{% endblock %}