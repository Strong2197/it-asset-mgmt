{% extends 'base.html' %}

{% block content %}
<style>
    /* Мобільна таблиця (адаптація) */
    @media (max-width: 768px) {
        .mobile-table thead { display: none; }
        .mobile-table, .mobile-table tbody, .mobile-table tr, .mobile-table td {
            display: block; width: 100%;
        }
        .mobile-table tr {
            margin-bottom: 1rem; background: #fff;
            border: 1px solid #e2e8f0; border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05); overflow: hidden;
        }
        .mobile-table td {
            text-align: right; padding-left: 1rem; position: relative;
            border-bottom: 1px solid #f1f5f9; padding: 0.75rem 1rem;
            display: flex; justify-content: space-between; align-items: center;
        }
        .mobile-table td::before {
            content: attr(data-label); font-weight: 600; color: #64748b; font-size: 0.85rem;
        }
        .mobile-table td:last-child {
            border-bottom: 0; justify-content: flex-end;
        }
        /* Специфічно для списку товарів на мобільному */
        .mobile-items-col {
            display: block !important; padding-left: 1rem !important; text-align: left !important;
        }
        .mobile-items-col::before { display: none; }
    }

    /* Ефект завантаження */
    .loading-overlay { position: relative; }
    .loading-overlay::after {
        content: ""; position: absolute; top: 0; left: 0; right: 0; bottom: 0;
        background: rgba(255, 255, 255, 0.7); z-index: 10; opacity: 0; pointer-events: none; transition: opacity 0.2s;
    }
    .loading .loading-overlay::after { opacity: 1; pointer-events: all; }

    /* Анімація появи кнопок */
    .animation-fade-in { animation: fadeIn 0.4s ease-out; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
</style>

<div class="row justify-content-center">
    <div class="col-12">

        <div class="d-flex flex-column flex-md-row justify-content-between align-items-center mb-4 gap-3">
            <div>
                <h2 class="fw-bold mb-1 text-dark">
                    <i class="bi bi-tools text-primary me-2"></i>Журнал сервісу
                </h2>
                <p class="text-muted mb-0 small">Обслуговування та ремонт техніки</p>
            </div>
            <div class="d-flex gap-2">
                <a href="{% url 'report_list' %}" class="btn btn-white border shadow-sm text-secondary">
                    <i class="bi bi-clock-history me-1"></i> Історія актів
                </a>
                <a href="{% url 'service_create' %}" class="btn btn-primary shadow-sm">
                    <i class="bi bi-plus-lg me-1"></i> Нова заявка
                </a>
            </div>
        </div>

        <div class="card border-0 shadow-sm mb-4 bg-primary-subtle overflow-hidden">
            <div class="card-body p-4 d-flex flex-column flex-md-row justify-content-between align-items-center gap-3">
                <div class="d-flex align-items-center">
                    <div class="bg-white p-3 rounded-circle shadow-sm me-3 text-primary">
                        <i class="bi bi-truck fs-4"></i>
                    </div>
                    <div>
                        <h5 class="fw-bold text-dark mb-1">Відправка в сервіс</h5>
                        <p class="text-muted small mb-0">Сформуйте акт передачі для техніки, що очікує ремонту.</p>
                    </div>
                </div>
                <div>
                    <a href="{% url 'print_preview' %}" class="btn btn-primary px-4 fw-semibold shadow-sm">
                        <i class="bi bi-file-earmark-text me-2"></i>Сформувати акт
                    </a>
                </div>
            </div>
        </div>

        <div class="card border-0 shadow-sm mb-4">
            <div class="card-body p-3">
                <div class="row g-3 align-items-center">
                    <div class="col-md-6">
                        <div class="bg-light p-1 rounded-3 d-inline-flex" id="filter-buttons">
                            <a href="?filter=all{% if search_query %}&q={{ search_query }}{% endif %}"
                               class="btn btn-sm px-3 rounded-2 border-0 filter-link {% if current_filter == 'all' %}bg-white shadow-sm fw-semibold text-dark{% else %}text-muted{% endif %}"
                               data-filter="all">Всі</a>

                            <a href="?filter=active{% if search_query %}&q={{ search_query }}{% endif %}"
                               class="btn btn-sm px-3 rounded-2 border-0 filter-link {% if current_filter == 'active' %}bg-white shadow-sm fw-semibold text-primary{% else %}text-muted{% endif %}"
                               data-filter="active">В роботі</a>

                            <a href="?filter=completed{% if search_query %}&q={{ search_query }}{% endif %}"
                               class="btn btn-sm px-3 rounded-2 border-0 filter-link {% if current_filter == 'completed' %}bg-white shadow-sm fw-semibold text-success{% else %}text-muted{% endif %}"
                               data-filter="completed">Архів</a>
                        </div>
                    </div>

                    <div class="col-md-6">
                        <div class="input-group">
                            <span class="input-group-text bg-light border-0 ps-3">
                                <i class="bi bi-search text-muted"></i>
                            </span>
                            <input type="text" id="service-search" value="{{ search_query }}" class="form-control border-0 bg-light" placeholder="Пошук картриджа, відділу..." autocomplete="off">
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="service-table-container" class="card border-0 shadow-sm loading-overlay">
            <div class="table-responsive">
                <table class="table table-hover align-middle mb-0 mobile-table">
                    <thead class="table-light text-secondary text-uppercase x-small fw-bold">
                        <tr>
                            <th class="ps-4" style="width: 5%;">Статус</th>
                            <th style="width: 50%;">Список робіт / Пристрої</th>
                            <th style="width: 25%;">Від кого</th>
                            <th style="width: 15%;">Дати</th>
                            <th class="text-end pe-4" style="width: 5%;"></th>
                        </tr>
                    </thead>
                    <tbody id="table-body">
                        {% for task in tasks %}
                        <tr class="service-row border-bottom-0">
                            <td class="ps-4 align-top pt-3" data-label="Статус">
                                {% if task.is_completed %}
                                    <div class="d-inline-flex align-items-center justify-content-center bg-success-subtle text-success rounded-circle" style="width: 32px; height: 32px;" title="Заявка закрита">
                                        <i class="bi bi-check-lg"></i>
                                    </div>
                                {% elif task.date_sent %}
                                    <div class="d-inline-flex align-items-center justify-content-center bg-primary-subtle text-primary rounded-circle" style="width: 32px; height: 32px;" title="В роботі (є акт)">
                                        <i class="bi bi-tools"></i>
                                    </div>
                                {% else %}
                                    <div class="d-inline-flex align-items-center justify-content-center bg-secondary-subtle text-secondary rounded-circle" style="width: 32px; height: 32px;" title="Нова заявка">
                                        <i class="bi bi-hourglass-split"></i>
                                    </div>
                                {% endif %}
                            </td>

                            <td class="align-top p-3 mobile-items-col">
                                {% if task.items.exists %}
                                    <div class="d-flex flex-column gap-2">
                                        {% for item in task.items.all %}
                                           <div class="d-flex flex-column flex-sm-row justify-content-between align-items-start align-items-sm-center bg-light rounded-3 p-2">

                                                <div class="d-flex align-items-center mb-2 mb-sm-0 me-3">
                                                    <div class="me-2 text-secondary opacity-50"><i class="bi bi-dot fs-4"></i></div>
                                                    <div style="line-height: 1.3;">
                                                        {% if item.item_name == 'Інше' %}
                                                            <span class="fw-semibold text-dark">{{ item.custom_name }}</span>
                                                        {% else %}
                                                            <span class="fw-semibold text-dark">{{ item.get_item_name_display }}</span>
                                                        {% endif %}

                                                        <span class="badge bg-white text-dark border ms-2 rounded-pill">{{ item.quantity }} шт.</span>

                                                        {% if item.note %}
                                                            <div class="text-muted small mt-1">
                                                                <i class="bi bi-chat-left-text me-1 opacity-50"></i>{{ item.note }}
                                                            </div>
                                                        {% endif %}
                                                    </div>
                                                </div>

                                                <div style="min-width: 140px;" id="action-block-{{ item.pk }}">
                                                    {% if not item.date_back_from_service %}
                                                        {% if task.date_sent %}
                                                            <a href="#"
                                                               data-url="{% url 'item_receive' item.pk %}"
                                                               data-qty="{{ item.quantity }}"
                                                               class="btn btn-sm btn-outline-success w-100 d-flex align-items-center justify-content-center gap-2 ajax-btn bg-white">
                                                                <i class="bi bi-box-seam"></i> Отримати
                                                            </a>
                                                        {% else %}
                                                            <div class="text-center text-muted x-small py-1 px-2 border rounded bg-white bg-opacity-50">
                                                                <i class="bi bi-clock me-1"></i> Очікує
                                                            </div>
                                                        {% endif %}
                                                    {% elif not item.date_returned_to_user %}
                                                        <div class="d-flex flex-column gap-1">
                                                            <div class="badge bg-info-subtle text-info-emphasis border border-info-subtle rounded-pill fw-normal">На складі</div>
                                                            <a href="#" data-url="{% url 'item_return' item.pk %}"
                                                               class="btn btn-sm btn-primary w-100 py-0 ajax-btn shadow-sm" style="font-size: 0.8rem; height: 26px; line-height: 24px;">
                                                                Видати <i class="bi bi-arrow-right ms-1"></i>
                                                            </a>
                                                        </div>
                                                    {% else %}
                                                        <div class="text-end text-success small fw-medium">
                                                            <i class="bi bi-check-all fs-5 align-middle me-1"></i>
                                                            Видано {{ item.date_returned_to_user|date:"d.m" }}
                                                        </div>
                                                    {% endif %}
                                                </div>
                                            </div>
                                        {% endfor %}
                                    </div>
                                {% else %}
                                    <div class="text-muted fst-italic p-2">{{ task.description|default:"Опис відсутній" }}</div>
                                {% endif %}
                            </td>

                            <td class="align-top pt-3" data-label="Від кого">
                                <div class="fw-semibold text-dark">{{ task.department }}</div>
                                <div class="small text-muted mt-1">
                                    <i class="bi bi-person me-1"></i>{{ task.requester_name }}
                                </div>
                            </td>

                            <td class="align-top pt-3" data-label="Дати">
                                <div class="d-flex flex-column gap-1 small text-muted">
                                    <div class="d-flex justify-content-between">
                                        <span>Створено:</span>
                                        <span class="fw-medium text-dark">{{ task.date_received|date:"d.m.Y" }}</span>
                                    </div>
                                    {% if task.date_sent %}
                                    <div class="d-flex justify-content-between">
                                        <span class="text-primary">В акті:</span>
                                        <span class="fw-medium text-primary">{{ task.date_sent|date:"d.m.Y" }}</span>
                                    </div>
                                    {% endif %}
                                </div>
                            </td>

                            <td class="align-top text-end pe-4 pt-3" data-label="Дії">
                                <a href="{% url 'service_update' task.pk %}" class="btn btn-sm btn-light text-secondary border-0 hover-bg-gray" title="Редагувати">
                                    <i class="bi bi-pencil"></i>
                                </a>
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="5" class="text-center py-5">
                                <div class="d-flex flex-column align-items-center justify-content-center text-muted">
                                    <i class="bi bi-inbox fs-1 mb-2 opacity-25"></i>
                                    <p class="mb-0">Заявок не знайдено</p>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

            <div class="card-footer bg-white border-top border-light py-3" id="pagination-container">
                <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
                    <small class="text-muted">
                        Всього: <strong>{{ total_count }}</strong> (Стор. {{ tasks.number }} з {{ tasks.paginator.num_pages }})
                    </small>

                    {% if tasks.paginator.num_pages > 1 %}
                    <nav>
                        <ul class="pagination pagination-sm mb-0">
                            {% if tasks.has_previous %}
                                <li class="page-item">
                                    <a class="page-link border-0 bg-light text-dark rounded-start" href="?page={{ tasks.previous_page_number }}&filter={{ current_filter }}{% if search_query %}&q={{ search_query }}{% endif %}">
                                        <i class="bi bi-chevron-left"></i>
                                    </a>
                                </li>
                            {% else %}
                                <li class="page-item disabled"><span class="page-link border-0 bg-light text-muted rounded-start"><i class="bi bi-chevron-left"></i></span></li>
                            {% endif %}

                            {% for i in tasks.paginator.page_range %}
                                {% if tasks.number == i %}
                                    <li class="page-item active"><span class="page-link border-0 bg-primary shadow-sm mx-1 rounded">{{ i }}</span></li>
                                {% elif i > tasks.number|add:'-3' and i < tasks.number|add:'3' %}
                                    <li class="page-item">
                                        <a class="page-link border-0 text-dark mx-1 rounded hover-bg-light" href="?page={{ i }}&filter={{ current_filter }}{% if search_query %}&q={{ search_query }}{% endif %}">{{ i }}</a>
                                    </li>
                                {% endif %}
                            {% endfor %}

                            {% if tasks.has_next %}
                                <li class="page-item">
                                    <a class="page-link border-0 bg-light text-dark rounded-end" href="?page={{ tasks.next_page_number }}&filter={{ current_filter }}{% if search_query %}&q={{ search_query }}{% endif %}">
                                        <i class="bi bi-chevron-right"></i>
                                    </a>
                                </li>
                            {% else %}
                                <li class="page-item disabled"><span class="page-link border-0 bg-light text-muted rounded-end"><i class="bi bi-chevron-right"></i></span></li>
                            {% endif %}
                        </ul>
                    </nav>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", function() {
    const searchInput = document.getElementById('service-search');
    const tableBody = document.getElementById('table-body');
    const paginationContainer = document.getElementById('pagination-container');
    const tableContainer = document.getElementById('service-table-container');
    let debounceTimer;

    // Функція завантаження даних
    function loadTableData(url) {
        if(tableContainer) tableContainer.classList.add('loading');

        fetch(url, {
            headers: { 'X-Requested-With': 'XMLHttpRequest' }
        })
        .then(response => response.text())
        .then(html => {
            const parser = new DOMParser();
            const doc = parser.parseFromString(html, 'text/html');

            const newTableBody = doc.getElementById('table-body');
            const newPagination = doc.getElementById('pagination-container');

            if (newTableBody && tableBody) tableBody.innerHTML = newTableBody.innerHTML;
            if (newPagination && paginationContainer) paginationContainer.innerHTML = newPagination.innerHTML;

            // Оновлюємо активний фільтр
            const currentUrlParams = new URLSearchParams(url.split('?')[1]);
            const newFilter = currentUrlParams.get('filter') || 'active';
            document.querySelectorAll('.filter-link').forEach(btn => {
                const isActive = btn.dataset.filter === newFilter;
                btn.classList.toggle('bg-white', isActive);
                btn.classList.toggle('shadow-sm', isActive);
                btn.classList.toggle('fw-semibold', isActive);

                // Кольори для активних кнопок
                if (isActive) {
                    btn.classList.remove('text-muted');
                    if (newFilter === 'active') btn.classList.add('text-primary');
                    else if (newFilter === 'completed') btn.classList.add('text-success');
                    else btn.classList.add('text-dark');
                } else {
                    btn.classList.add('text-muted');
                    btn.classList.remove('text-primary', 'text-success', 'text-dark');
                }
            });

            window.history.pushState({path: url}, '', url);
        })
        .catch(err => console.error('Error:', err))
        .finally(() => {
            if(tableContainer) tableContainer.classList.remove('loading');
        });
    }

    // Делегування подій для пагінації та фільтрів
    document.addEventListener('click', function(e) {
        const link = e.target.closest('.page-link, .filter-link');
        if (link && link.getAttribute('href') && !link.parentElement.classList.contains('disabled')) {
            e.preventDefault();
            loadTableData(link.getAttribute('href'));
        }
    });

    // Пошук
    if (searchInput) {
        searchInput.addEventListener('input', function() {
            clearTimeout(debounceTimer);
            const query = this.value.trim();
            const urlParams = new URLSearchParams(window.location.search);
            const filter = urlParams.get('filter') || 'active';

            debounceTimer = setTimeout(() => {
                const newUrl = `${window.location.pathname}?q=${encodeURIComponent(query)}&filter=${filter}`;
                loadTableData(newUrl);
            }, 400);
        });
    }

    // AJAX для кнопок "Отримати" / "Видати"
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    const csrftoken = getCookie('csrftoken');

    document.body.addEventListener('click', function(e) {
        const btn = e.target.closest('.ajax-btn');
        if (btn) {
            e.preventDefault();

            let url = btn.getAttribute('data-url');
            const isReceiveBtn = url.includes('receive');
            let quantity = parseInt(btn.getAttribute('data-qty') || 1);
            let qtyToReceive = quantity;

            if (isReceiveBtn && quantity > 1) {
                let input = prompt(`Всього у заявці: ${quantity} шт.\nСкільки повернулось з ремонту?`, quantity);
                if (input === null) return;
                qtyToReceive = parseInt(input);
                if (isNaN(qtyToReceive) || qtyToReceive <= 0 || qtyToReceive > quantity) {
                    alert("Некоректна кількість!"); return;
                }
                url += `?qty=${qtyToReceive}`;
            }

            const container = btn.closest('div[id^="action-block-"]');
            const originalContent = btn.innerHTML;

            // Спінер
            btn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>';
            btn.classList.add('disabled', 'border-0'); // Прибираємо рамку щоб не стрибало

            fetch(url, {
                method: 'GET',
                headers: { 'X-Requested-With': 'XMLHttpRequest', 'X-CSRFToken': csrftoken }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    if (data.is_split) {
                        window.location.reload();
                    } else {
                        if (data.new_state === 'stocked') {
                            container.innerHTML = `<div class="d-flex flex-column gap-1 animation-fade-in"><div class="badge bg-info-subtle text-info-emphasis border border-info-subtle rounded-pill fw-normal">На складі</div><a href="#" data-url="${data.return_url}" class="btn btn-sm btn-primary w-100 py-0 ajax-btn shadow-sm" style="font-size: 0.8rem; height: 26px; line-height: 24px;">Видати <i class="bi bi-arrow-right ms-1"></i></a></div>`;
                        } else if (data.new_state === 'issued') {
                            container.innerHTML = `<div class="text-end text-success small fw-medium animation-fade-in"><i class="bi bi-check-all fs-5 align-middle me-1"></i> Видано ${data.date_str}</div>`;
                            // Оновлюємо головний статус, якщо заявка закрита
                            if (data.task_completed) {
                                const row = container.closest('tr');
                                if (row) {
                                    const statusCell = row.querySelector('td[data-label="Статус"]');
                                    if (statusCell) statusCell.innerHTML = '<div class="d-inline-flex align-items-center justify-content-center bg-success-subtle text-success rounded-circle" style="width: 32px; height: 32px;" title="Заявка закрита"><i class="bi bi-check-lg"></i></div>';
                                }
                            }
                        }
                    }
                } else {
                    alert('Помилка сервера.');
                    btn.innerHTML = originalContent;
                    btn.classList.remove('disabled', 'border-0');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                btn.innerHTML = originalContent;
                btn.classList.remove('disabled', 'border-0');
            });
        }
    });
});
</script>
{% endblock %}