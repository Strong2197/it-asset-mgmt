{% extends 'base.html' %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-9">
        <div class="card shadow-sm">
            <div class="card-header bg-warning text-dark">
                <h4 class="mb-0">{{ title }}</h4>
            </div>
            <div class="card-body">
                <form method="post" id="service-form">
                    {% csrf_token %}

                    {% for field in form %}
                    <div class="mb-3">
                        {% if field.name == 'department' %}
                            <label class="form-label fw-bold">–í—ñ–¥–¥—ñ–ª</label>
                            <input type="text" name="{{ field.name }}"
                                   value="{{ field.value|default:'' }}"
                                   class="form-control" list="dept-list"
                                   placeholder="–í–≤–µ–¥—ñ—Ç—å –Ω–∞–∑–≤—É –≤—ñ–¥–¥—ñ–ª—É..." autocomplete="off">
                            <datalist id="dept-list">
                                {% for dept in departments %}
                                    <option value="{{ dept }}">
                                {% endfor %}
                            </datalist>
                        {% elif field.name == 'is_completed' %}
                            <div class="form-check">
                                {{ field }}
                                <label class="form-check-label fw-bold">{{ field.label }}</label>
                            </div>
                        {% else %}
                            <label class="form-label fw-bold">{{ field.label }}</label>
                            {{ field }}
                        {% endif %}
                    </div>
                    {% endfor %}

                    <hr>
                    <label class="form-label fw-bold mb-3">–°–ø–∏—Å–æ–∫ –∫–∞—Ä—Ç—Ä–∏–¥–∂—ñ–≤:</label>

                    {{ formset.management_form }}

                    <div id="items-container">
                        {% for item_form in formset %}
                        <div class="card mb-2 border-secondary item-row">
                            <div class="card-body p-2">
                                {% for hidden in item_form.hidden_fields %}
                                    {{ hidden }}
                                {% endfor %}

                                <div class="row g-2 align-items-center">
                                    <div class="col-md-6">
                                        <div class="mb-1">
                                            {{ item_form.item_name }}
                                        </div>

                                        <div class="custom-name-wrapper" style="display:none;">
                                            {{ item_form.custom_name }}
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="input-group input-group-sm">
                                            <span class="input-group-text">–ö-—Ç—å</span>
                                            {{ item_form.quantity }}
                                        </div>
                                    </div>
                                    <div class="col-md-3 text-end">
                                        {% if formset.can_delete %}
                                            <div class="d-none">{{ item_form.DELETE }}</div>
                                            <button type="button" class="btn btn-outline-danger btn-sm delete-row-btn">
                                                <i class="bi bi-trash"></i>
                                            </button>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>

                    <button type="button" id="add-item" class="btn btn-outline-primary btn-sm mt-2 mb-3">
                        <i class="bi bi-plus-lg"></i> –î–æ–¥–∞—Ç–∏ –ø–æ–∑–∏—Ü—ñ—é
                    </button>

                    <div class="d-flex justify-content-between mt-4">
                        <a href="{% url 'service_list' %}" class="btn btn-secondary">–°–∫–∞—Å—É–≤–∞—Ç–∏</a>
                        <button type="submit" class="btn btn-warning shadow-sm">üíæ –ó–±–µ—Ä–µ–≥—Ç–∏</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const container = document.getElementById('items-container');
    const addButton = document.getElementById('add-item');
    const totalForms = document.getElementById('id_items-TOTAL_FORMS');

    // --- –§–£–ù–ö–¶–Ü–Ø: –ü–µ—Ä–µ–º–∏–∫–∞–Ω–Ω—è –ø–æ–ª—è "–Ü–Ω—à–µ" ---
    function toggleCustomField(selectElement) {
        // –ó–Ω–∞—Ö–æ–¥–∏–º–æ –±–∞—Ç—å–∫—ñ–≤—Å—å–∫–∏–π —Ä—è–¥–æ–∫
        const row = selectElement.closest('.item-row');
        // –ó–Ω–∞—Ö–æ–¥–∏–º–æ –æ–±–≥–æ—Ä—Ç–∫—É –¥–ª—è –Ω–∞—à–æ–≥–æ –ø–æ–ª—è
        const wrapper = row.querySelector('.custom-name-wrapper');
        // –ó–Ω–∞—Ö–æ–¥–∏–º–æ —Å–∞–º–µ –ø–æ–ª–µ input –≤—Å–µ—Ä–µ–¥–∏–Ω—ñ
        const input = wrapper.querySelector('input');

        console.log("–°—Ç–∞—Ç—É—Å:", selectElement.value);

        // –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ, —á–∏ –≤–∏–±—Ä–∞–Ω–æ '–Ü–Ω—à–µ'
        if (selectElement.value === '–Ü–Ω—à–µ') {
            // 1. –ü–æ–∫–∞–∑—É—î–º–æ –æ–±–≥–æ—Ä—Ç–∫—É
            wrapper.style.display = 'block';

            // 2. –í–ê–ñ–õ–ò–í–û: –ü—Ä–∏–º—É—Å–æ–≤–æ –ø–æ–∫–∞–∑—É—î–º–æ —Å–∞–º input (–≤–∏–ø—Ä–∞–≤–ª—è—î–º–æ –∫–æ–Ω—Ñ–ª—ñ–∫—Ç –∑ forms.py)
            if (input) {
                input.style.display = 'block';
                input.required = true;
                input.placeholder = "–ù–∞–ø–∏—à—ñ—Ç—å –Ω–∞–∑–≤—É –ø—Ä–∏—Å—Ç—Ä–æ—é...";
                input.focus(); // –°—Ç–∞–≤–∏–º–æ –∫—É—Ä—Å–æ—Ä –≤—Å–µ—Ä–µ–¥–∏–Ω—É, —â–æ–± –∑—Ä—É—á–Ω–æ –ø–∏—Å–∞—Ç–∏
            }
        } else {
            // –•–æ–≤–∞—î–º–æ –≤—Å–µ –Ω–∞–∑–∞–¥
            wrapper.style.display = 'none';
            if (input) {
                input.value = '';
                input.required = false;
            }
        }
    }

    // --- –°–õ–£–•–ê–ß –ü–û–î–Ü–ô (Delegation) ---
    container.addEventListener('change', function(e) {
        // –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ, —á–∏ —Ü–µ –≤–∏–ø–∞–¥–∞—é—á–∏–π —Å–ø–∏—Å–æ–∫ –∑ –Ω–∞–∑–≤–æ—é 'item_name'
        if (e.target.matches('select') && e.target.name.includes('item_name')) {
            toggleCustomField(e.target);
        }
    });

    // --- –Ü–ù–Ü–¶–Ü–ê–õ–Ü–ó–ê–¶–Ü–Ø ---
    // –ü—Ä–æ—Ö–æ–¥–∏–º–æ –ø–æ –≤—Å—ñ—Ö —Å–ø–∏—Å–∫–∞—Ö –ø—Ä–∏ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—ñ (—â–æ–± –≤—ñ–¥–∫—Ä–∏—Ç–∏ "–Ü–Ω—à–µ" –ø—Ä–∏ —Ä–µ–¥–∞–≥—É–≤–∞–Ω–Ω—ñ)
    const allSelects = container.querySelectorAll('select[name$="item_name"]');
    allSelects.forEach(select => {
        toggleCustomField(select);
    });

    // --- –õ–û–ì–Ü–ö–ê –í–ò–î–ê–õ–ï–ù–ù–Ø ---
    container.addEventListener('click', function(e) {
        if (e.target.closest('.delete-row-btn')) {
            const row = e.target.closest('.item-row');
            const deleteCheckbox = row.querySelector('input[name$="-DELETE"]');

            if (deleteCheckbox) {
                deleteCheckbox.checked = true; // –°—Ç–∞–≤–∏–º–æ –≥–∞–ª–æ—á–∫—É –≤–∏–¥–∞–ª–µ–Ω–Ω—è –¥–ª—è Django
                row.style.display = 'none';    // –•–æ–≤–∞—î–º–æ —Ä—è–¥–æ–∫ –≤—ñ–∑—É–∞–ª—å–Ω–æ
            } else {
                row.remove(); // –Ø–∫—â–æ —Ü–µ –Ω–æ–≤–∏–π —Ä—è–¥–æ–∫ - –ø—Ä–æ—Å—Ç–æ –≤–∏–¥–∞–ª—è—î–º–æ
            }
        }
    });

    // --- –õ–û–ì–Ü–ö–ê –î–û–î–ê–í–ê–ù–ù–Ø –ù–û–í–û–ì–û –†–Ø–î–ö–ê ---
    addButton.addEventListener('click', function() {
        const formsCount = parseInt(totalForms.value);
        const firstRow = container.querySelector('.item-row');

        // –ö–ª–æ–Ω—É—î–º–æ –ø–µ—Ä—à–∏–π —Ä—è–¥–æ–∫
        const newRow = firstRow.cloneNode(true);
        const regex = new RegExp(`items-(\\d+)-`, 'g');
        newRow.innerHTML = newRow.innerHTML.replace(regex, `items-${formsCount}-`);

        // –û—á–∏—â–∞—î–º–æ –≤—Å—ñ –ø–æ–ª—è –≤ –Ω–æ–≤–æ–º—É —Ä—è–¥–∫—É
        newRow.querySelectorAll('input, select').forEach(el => {
            if (el.type !== 'hidden') {
                el.value = '';
                // –°–∫–∏–¥–∞—î–º–æ —Å—Ç–∏–ª—ñ, —â–æ–± –ø–æ–ª–µ "–Ü–Ω—à–µ" –±—É–ª–æ —Å—Ö–æ–≤–∞–Ω–µ –∑–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º
                if (el.name.includes('custom_name')) el.style.display = 'none';
                if (el.name.includes('quantity')) el.value = 1;
            }
            if (el.type === 'checkbox') el.checked = false;
        });

        // –°–∫–∏–¥–∞—î–º–æ –æ–±–≥–æ—Ä—Ç–∫—É "–Ü–Ω—à–µ"
        const wrapper = newRow.querySelector('.custom-name-wrapper');
        if(wrapper) wrapper.style.display = 'none';

        // –ü–æ–∫–∞–∑—É—î–º–æ —Å–∞–º —Ä—è–¥–æ–∫
        newRow.style.display = 'block';

        container.appendChild(newRow);
        totalForms.value = formsCount + 1;
    });
});
</script>
{% endblock %}