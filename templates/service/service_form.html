{% extends 'base.html' %}

{% block content %}
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />

<style>
    /* –°—Ç–∏–ª—ñ–∑–∞—Ü—ñ—è Select2 */
    .select2-container .select2-selection--single {
        height: 34px !important;
        border: 1px solid #dee2e6 !important;
        display: flex; align-items: center; font-size: 0.9rem;
    }
    .select2-container--default .select2-selection--single .select2-selection__arrow { height: 32px !important; }

    /* –°—Ç–∏–ª—ñ –¥–ª—è —Ñ–æ—Ä–º–∏ */
    .form-label-small {
        font-size: 0.75rem;
        font-weight: 700;
        color: #6c757d;
        text-transform: uppercase;
        margin-bottom: 0.2rem;
    }

    .item-row { transition: all 0.2s; }
    .item-row:hover { background-color: #fff !important; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }

    .is-invalid .select2-selection,
    .is-invalid.form-control { border-color: #dc3545 !important; }

    /* –°—ñ—Ç–∫–∞ –¥–ª—è –¥–∞—Ç —É —Å–∞–π–¥–±–∞—Ä—ñ (2 —Å—Ç–æ–≤–ø—á–∏–∫–∏) */
    .dates-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 10px;
    }
</style>

<div class="row justify-content-center">
    <div class="col-12">

        <div class="d-flex justify-content-between align-items-center mb-3">
            <a href="{% url 'service_list' %}" class="text-decoration-none text-muted small hover-link">
                <i class="bi bi-arrow-left me-1"></i>–ù–∞–∑–∞–¥
            </a>
            <h5 class="fw-bold text-dark mb-0">
                {% if 'update' in request.path %}
                    <i class="bi bi-pencil-square text-primary me-2"></i>–†–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è –∑–∞—è–≤–∫–∏
                {% else %}
                    <i class="bi bi-plus-circle text-success me-2"></i>–ù–æ–≤–∞ –∑–∞—è–≤–∫–∞
                {% endif %}
            </h5>
            <div style="width: 60px;"></div>
        </div>

        <form method="post" id="service-form" novalidate>
            {% csrf_token %}

            {% if form.errors or formset.errors %}
            <div class="alert alert-danger shadow-sm mb-4">
                <h6 class="alert-heading fw-bold"><i class="bi bi-exclamation-triangle-fill me-2"></i>–ü–æ–º–∏–ª–∫–∏:</h6>
                <ul class="mb-0 small">
                    {% for field in form %}
                        {% for error in field.errors %}<li><strong>{{ field.label }}:</strong> {{ error }}</li>{% endfor %}
                    {% endfor %}
                    {% for error in form.non_field_errors %}<li>{{ error }}</li>{% endfor %}
                    {% if formset.total_error_count %}<li>–ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ —Å–ø–∏—Å–æ–∫ –∫–∞—Ä—Ç—Ä–∏–¥–∂—ñ–≤ (–ø–æ–ª—è –≤–∏–¥—ñ–ª–µ–Ω—ñ —á–µ—Ä–≤–æ–Ω–∏–º).</li>{% endif %}
                </ul>
            </div>
            {% endif %}

            <div class="row g-4">

                <div class="col-lg-8">
                    <div class="card border-0 shadow-sm rounded-3 h-100">
                        <div class="card-body p-4">

                            <div class="mb-3">
                                {% for field in form %}
                                    {% if field.name not in 'requester_name,department,is_completed,description' and 'date' not in field.name %}
                                        <div class="mb-2">
                                            <label class="form-label-small">{{ field.label }}</label>
                                            {{ field }}
                                            <div class="text-danger x-small">{{ field.errors.0 }}</div>
                                        </div>
                                    {% endif %}
                                {% endfor %}
                            </div>

                            <div class="row g-3 mb-3">
                                <div class="col-md-6">
                                    <label class="form-label-small">–ó–∞–º–æ–≤–Ω–∏–∫ (–ü–Ü–ë)</label>
                                    <select name="requester_name" id="id_requester_name" class="form-control form-control-sm {% if form.requester_name.errors %}is-invalid{% endif %}" style="width: 100%;">
                                        {% if form.requester_name.value %}<option value="{{ form.requester_name.value }}" selected>{{ form.requester_name.value }}</option>{% endif %}
                                        <option></option>
                                        {% for name in requesters %}{% if name != form.requester_name.value %}<option value="{{ name }}">{{ name }}</option>{% endif %}{% endfor %}
                                    </select>
                                    <div class="text-danger x-small">{{ form.requester_name.errors.0 }}</div>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label-small">–í—ñ–¥–¥—ñ–ª</label>
                                    <select name="department" id="id_department" class="form-control form-control-sm {% if form.department.errors %}is-invalid{% endif %}" style="width: 100%;">
                                        {% if form.department.value %}<option value="{{ form.department.value }}" selected>{{ form.department.value }}</option>{% endif %}
                                        <option></option>
                                        {% for dept in departments %}{% if dept != form.department.value %}<option value="{{ dept }}">{{ dept }}</option>{% endif %}{% endfor %}
                                    </select>
                                    <div class="text-danger x-small">{{ form.department.errors.0 }}</div>
                                </div>
                            </div>

                            <div class="mb-4 text-end border-bottom pb-3">
                                <div class="form-check form-switch d-inline-block">
                                    {{ form.is_completed }}
                                    <label class="form-check-label fw-bold text-success small ms-1" for="{{ form.is_completed.id_for_label }}">
                                        –ó–∞—è–≤–∫—É –≤–∏–∫–æ–Ω–∞–Ω–æ / –ó–∞–∫—Ä–∏—Ç–∏
                                    </label>
                                </div>
                            </div>

                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <label class="form-label-small text-primary mb-0">–°–ø–∏—Å–æ–∫ –∫–∞—Ä—Ç—Ä–∏–¥–∂—ñ–≤ / –†–æ–±—ñ—Ç</label>
                                <button type="button" id="add-item" class="btn btn-sm btn-light text-primary border rounded-pill px-3 py-0" style="font-size: 0.8rem;">
                                    <i class="bi bi-plus-lg"></i> –î–æ–¥–∞—Ç–∏
                                </button>
                            </div>

                            {{ formset.management_form }}
                            <div class="text-danger small mb-2">{{ formset.non_form_errors }}</div>

                            <div id="items-container" class="bg-light rounded-3 p-2">
                                {% for item_form in formset %}
                                <div class="card mb-2 border-0 shadow-sm item-row">
                                    <div class="card-body p-2">
                                        {% for hidden in item_form.hidden_fields %}{{ hidden }}{% endfor %}

                                        <div class="row g-2 align-items-start">
                                            <div class="col-md-5 col-12">
                                                <div class="{% if item_form.item_name.errors %}is-invalid-select{% endif %}">
                                                    {{ item_form.item_name }}
                                                </div>
                                                <div class="text-danger x-small mt-1">{{ item_form.item_name.errors.0 }}</div>
                                                <div class="custom-name-wrapper mt-1" style="display:none;">
                                                    {{ item_form.custom_name }}
                                                    <div class="text-danger x-small">{{ item_form.custom_name.errors.0 }}</div>
                                                </div>
                                            </div>
                                            <div class="col-md-4 col-12">
                                                <div class="input-group input-group-sm">
                                                    <button type="button" class="btn btn-light border text-muted emoji-trigger px-2">üòä</button>
                                                    {{ item_form.note }}
                                                </div>
                                            </div>
                                            <div class="col-md-3 col-12">
                                                <div class="d-flex align-items-start justify-content-end gap-2">
                                                    <div style="width: 80px;">
                                                        {{ item_form.quantity }}
                                                        <div class="text-danger x-small text-center">{{ item_form.quantity.errors.0 }}</div>
                                                    </div>
                                                    {% if formset.can_delete %}
                                                        <div class="d-none">{{ item_form.DELETE }}</div>
                                                        <button type="button" class="btn btn-sm text-danger delete-row-btn p-1 mt-1" title="–í–∏–¥–∞–ª–∏—Ç–∏">
                                                            <i class="bi bi-x-circle-fill fs-5"></i>
                                                        </button>
                                                    {% endif %}
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>

                            <div class="mt-3">
                                <label class="form-label-small">{{ form.description.label }}</label>
                                {{ form.description }}
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-lg-4">

                    <div class="card border-0 shadow-sm rounded-3 mb-3">
                        <div class="card-header bg-white border-bottom py-2">
                            <h6 class="fw-bold text-dark mb-0 small"><i class="bi bi-calendar3 me-2"></i>–î–∞—Ç–∏ —Ç–∞ –¢–µ—Ä–º—ñ–Ω–∏</h6>
                        </div>
                        <div class="card-body p-3 bg-light rounded-bottom-3">

                            <div class="dates-grid">
                                {% for field in form %}
                                    {% if 'date' in field.name %}
                                        <div class="mb-1">
                                            <label class="form-label-small" style="font-size: 0.7rem;">{{ field.label }}</label>
                                            {{ field }}
                                            <div class="text-danger x-small">{{ field.errors.0 }}</div>
                                        </div>
                                    {% endif %}
                                {% endfor %}
                            </div>

                        </div>
                    </div>

                    <div class="card border-0 shadow-sm rounded-3 mb-3">
                        <div class="card-header bg-white border-bottom-0 py-2">
                            <a class="text-decoration-none fw-bold text-secondary small d-block w-100" data-bs-toggle="collapse" href="#codesCollapse">
                                <i class="bi bi-info-circle me-1"></i> –ö–æ–¥–∏ –≤—ñ–¥–¥—ñ–ª—ñ–≤ <i class="bi bi-chevron-down float-end"></i>
                            </a>
                        </div>
                        <div class="collapse show" id="codesCollapse">
                            <div class="card-body p-0">
                                <table class="table table-sm table-striped mb-0" style="font-size: 0.8rem;">
                                    <tbody>
                                        <tr><td class="ps-3">–Ü–≤–∞–Ω–æ-–§—Ä–∞–Ω–∫—ñ–≤—Å—å–∫–∏–π</td><td class="text-end pe-3 fw-bold">2610</td></tr>
                                        <tr><td class="ps-3">–Ø—Ä–µ–º—á–∞–Ω—Å—å–∫–∏–π</td><td class="text-end pe-3 fw-bold">2612</td></tr>
                                        <tr><td class="ps-3">–ì–æ—Ä–æ–¥–µ–Ω–∫—ñ–≤—Å—å–∫–∏–π</td><td class="text-end pe-3 fw-bold">2616</td></tr>
                                        <tr><td class="ps-3">–î–æ–ª–∏–Ω—Å—å–∫–∏–π</td><td class="text-end pe-3 fw-bold">2617</td></tr>
                                        <tr><td class="ps-3">–ö–æ–ª–æ–º–∏–π—Å—å–∫–∏–π</td><td class="text-end pe-3 fw-bold">2619</td></tr>
                                        <tr><td class="ps-3">–ö–æ—Å—ñ–≤—Å—å–∫–∏–π</td><td class="text-end pe-3 fw-bold">2620</td></tr>
                                        <tr><td class="ps-3">–ù–∞–¥–≤—ñ—Ä–Ω—è–Ω—Å—å–∫–∏–π</td><td class="text-end pe-3 fw-bold">2621</td></tr>
                                        <tr><td class="ps-3">–†–æ–≥–∞—Ç–∏–Ω—Å—å–∫–∏–π</td><td class="text-end pe-3 fw-bold">2622</td></tr>
                                        <tr><td class="ps-3">–¢–∏—Å–º–µ–Ω–∏—Ü—å–∫–∏–π</td><td class="text-end pe-3 fw-bold">2626</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <div class="d-grid gap-2">
                        <button type="submit" class="btn btn-primary fw-semibold shadow-sm">
                            <i class="bi bi-check-lg me-1"></i> –ó–±–µ—Ä–µ–≥—Ç–∏ –∑–º—ñ–Ω–∏
                        </button>
                        <a href="{% url 'service_list' %}" class="btn btn-outline-secondary btn-sm">–°–∫–∞—Å—É–≤–∞—Ç–∏</a>
                    </div>
                </div>
            </div>
        </form>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

<script>
const emojiLibLoader = import('https://cdn.jsdelivr.net/npm/@joeattardi/emoji-button@4.6.4/dist/index.min.js')
    .then(module => module.EmojiButton)
    .catch(err => { console.error("–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Å–º–∞–π–ª–∏–∫—ñ–≤:", err); return null; });

$(document).ready(function() {

    // –°—Ç–∏–ª—ñ–∑–∞—Ü—ñ—è
    $('input[type="text"], input[type="date"], select, textarea').not('.select2-hidden-accessible, .form-check-input').addClass('form-control form-control-sm');
    $('textarea').attr('rows', 2);

    // Select2
    $('#id_requester_name, #id_department').select2({ tags: true, placeholder: "...", allowClear: true, width: '100%' });

    // –ê–≤—Ç–æ–∑–∞–ø–æ–≤–Ω–µ–Ω–Ω—è
    $('#id_requester_name').on('select2:select change', function (e) {
        const name = $(this).val();
        if (name && name.length > 2) {
            fetch(`{% url 'get_last_department' %}?name=${encodeURIComponent(name)}`)
                .then(response => response.json())
                .then(data => {
                    if (data.found && data.department) {
                        const $dept = $('#id_department');
                        if (!$dept.find("option[value='" + data.department + "']").length) {
                            $dept.append(new Option(data.department, data.department, true, true));
                        }
                        $dept.val(data.department).trigger('change');
                    }
                });
        }
    });

    const container = document.getElementById('items-container');
    const addButton = document.getElementById('add-item');
    const totalForms = document.getElementById('id_items-TOTAL_FORMS');
    let picker = null;
    let currentInputForEmoji = null;

    container.addEventListener('click', async function(e) {
        const emojiBtn = e.target.closest('.emoji-trigger');
        if (emojiBtn) {
            const input = emojiBtn.closest('.input-group').querySelector('input');
            currentInputForEmoji = input;
            if (picker) { picker.togglePicker(emojiBtn); return; }

            try {
                const EmojiButtonClass = await emojiLibLoader;
                if (EmojiButtonClass) {
                    picker = new EmojiButtonClass({ position: 'bottom-start', emojiSize: '1.2em', autoHide: false, zIndex: 9999 });
                    picker.on('emoji', selection => {
                        if (currentInputForEmoji) { currentInputForEmoji.value += selection.emoji; currentInputForEmoji.focus(); }
                    });
                    picker.togglePicker(emojiBtn);
                }
            } catch (err) { console.error(err); }
            return;
        }

        if (e.target.closest('.delete-row-btn')) {
            const row = e.target.closest('.item-row');
            const delBox = row.querySelector('input[name$="-DELETE"]');
            if (delBox) { delBox.checked = true; row.style.display = 'none'; } else { row.remove(); }
        }
    });

    function toggleCustomField(selectElement) {
        const row = selectElement.closest('.item-row');
        const customWrapper = row.querySelector('.custom-name-wrapper');
        const input = customWrapper.querySelector('input');

        if (selectElement.value === '–Ü–Ω—à–µ') {
            customWrapper.style.display = 'block';
            if(input) {
                input.style.display = 'block';
                input.required = true;
                input.classList.add('form-control', 'form-control-sm');
            }
        } else {
            customWrapper.style.display = 'none';
            if(input) {
                input.required = false;
                input.value = '';
            }
        }
    }

    container.addEventListener('change', function(e) {
        if (e.target.matches('select') && e.target.name.includes('item_name')) {
            toggleCustomField(e.target);
        }
    });

    addButton.addEventListener('click', function() {
        const formsCount = parseInt(totalForms.value);
        const firstRow = container.querySelector('.item-row');
        const newRow = firstRow.cloneNode(true);
        const regex = new RegExp(`items-(\\d+)-`, 'g');
        newRow.innerHTML = newRow.innerHTML.replace(regex, `items-${formsCount}-`);

        newRow.querySelectorAll('input, select').forEach(el => {
            if (el.type !== 'hidden') {
                el.value = '';
                if (el.name.includes('quantity')) el.value = 1;
            }
            el.classList.remove('is-invalid');
            el.required = false;
            el.classList.add('form-control', 'form-control-sm');
            if (el.type === 'checkbox') el.checked = false;
        });

        const customWrapper = newRow.querySelector('.custom-name-wrapper');
        const customInput = customWrapper.querySelector('input');
        if(customWrapper) customWrapper.style.display = 'none';
        if(customInput) customInput.required = false;

        newRow.querySelectorAll('.text-danger').forEach(div => div.remove());

        newRow.style.display = 'block';
        container.appendChild(newRow);
        totalForms.value = formsCount + 1;
    });

    document.querySelectorAll('select[name$="item_name"]').forEach(select => {
        toggleCustomField(select);
    });
});
</script>
{% endblock %}