{% extends 'base.html' %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-8">
        <div class="card shadow-sm"> <div class="card-header bg-warning text-dark">
                <h4 class="mb-0">{{ title }}</h4>
            </div>
            <div class="card-body">
                <form method="post">
                    {% csrf_token %}

                    {% for field in form %}
                    <div class="mb-3">

                        {% if field.name == 'is_completed' %}
                            <div class="form-check">
                                {{ field }}
                                <label class="form-check-label fw-bold">{{ field.label }}</label>
                            </div>

                        {% elif field.name == 'department' %}
                            <label class="form-label fw-bold">{{ field.label }}</label>
                            <input type="text"
                                   name="{{ field.name }}"
                                   value="{{ field.value|default:'' }}"
                                   class="form-control"
                                   list="dept-list"
                                   placeholder="–ü–æ—á–Ω—ñ—Ç—å –≤–≤–æ–¥–∏—Ç–∏ –Ω–∞–∑–≤—É –≤—ñ–¥–¥—ñ–ª—É..."
                                   autocomplete="off">

                            <datalist id="dept-list">
                                {% for dept in departments %}
                                    <option value="{{ dept }}">
                                {% endfor %}
                            </datalist>

                        {% elif field.name == 'device_name' %}
                            <label class="form-label fw-bold">{{ field.label }}</label>

                            {{ field }}

                            <select id="device-select" class="form-select mb-2">
                                <option value="" selected disabled>-- –û–±–µ—Ä—ñ—Ç—å –∑—ñ —Å–ø–∏—Å–∫—É --</option>
                                {% for val, name in cartridges %}
                                    <option value="{{ val }}">{{ name }}</option>
                                {% endfor %}
                                <option value="OTHER_OPTION_MARKER" class="fw-bold text-primary">-- –Ü–Ω—à–µ (–≤–ø–∏—Å–∞—Ç–∏ –≤—Ä—É—á–Ω—É) --</option>
                            </select>

                            <div id="custom-device-block" style="display: none;">
                                <input type="text" id="custom-device-input" class="form-control border-primary" placeholder="–í–≤–µ–¥—ñ—Ç—å –ø–æ–≤–Ω—É –Ω–∞–∑–≤—É...">
                                <div class="form-text text-muted small">–Ø–∫—â–æ –º–æ–¥–µ–ª—ñ –Ω–µ–º–∞—î –≤ —Å–ø–∏—Å–∫—É, –Ω–∞–ø–∏—à—ñ—Ç—å —ó—ó —Ç—É—Ç.</div>
                            </div>

                        {% else %}
                            <label class="form-label fw-bold">{{ field.label }}</label>
                            {{ field }}
                        {% endif %}

                        {% if field.errors %}
                            <div class="text-danger small">{{ field.errors.0 }}</div>
                        {% endif %}
                    </div>
                    {% endfor %}

                    <div class="d-flex justify-content-between mt-4">
                        <a href="{% url 'service_list' %}" class="btn btn-secondary">–°–∫–∞—Å—É–≤–∞—Ç–∏</a>
                        <button type="submit" class="btn btn-warning shadow-sm">üíæ –ó–±–µ—Ä–µ–≥—Ç–∏</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // –ó–Ω–∞—Ö–æ–¥–∏–º–æ –µ–ª–µ–º–µ–Ω—Ç–∏ –∑–∞ ID (–ø–µ—Ä–µ–∫–æ–Ω–∞–π—Ç–µ—Å—å, —â–æ —É forms.py –¥–ª—è device_name —Å—Ç–æ—ó—Ç—å id='real-device-name')
    const realInput = document.getElementById('real-device-name');
    const select = document.getElementById('device-select');
    const customBlock = document.getElementById('custom-device-block');
    const customInput = document.getElementById('custom-device-input');

    // –Ø–∫—â–æ –µ–ª–µ–º–µ–Ω—Ç—ñ–≤ –Ω–µ–º–∞—î (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, —Ñ–æ—Ä–º–∞ —ñ–Ω—à–æ–≥–æ —Ç–∏–ø—É), –≤–∏—Ö–æ–¥–∏–º–æ
    if (!realInput || !select) return;

    // 1. –ü—Ä–∏ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—ñ: –ø–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ, —â–æ –∑–∞—Ä–∞–∑ –∑–∞–ø–∏—Å–∞–Ω–æ –≤ –±–∞–∑—ñ
    const currentValue = realInput.value;
    let foundInList = false;

    if (currentValue) {
        // –®—É–∫–∞—î–º–æ, —á–∏ —î —Ü–µ –∑–Ω–∞—á–µ–Ω–Ω—è —É —Å–ø–∏—Å–∫—É select
        for (let i = 0; i < select.options.length; i++) {
            if (select.options[i].value === currentValue) {
                select.selectedIndex = i;
                foundInList = true;
                break;
            }
        }
        // –Ø–∫—â–æ –∑–Ω–∞—á–µ–Ω–Ω—è —î, –∞–ª–µ –≤ —Å–ø–∏—Å–∫—É –π–æ–≥–æ –Ω–µ–º–∞—î -> —Ü–µ "–Ü–Ω—à–µ"
        if (!foundInList) {
            select.value = "OTHER_OPTION_MARKER";
            customBlock.style.display = 'block';
            customInput.value = currentValue;
        }
    }

    // 2. –ö–æ–ª–∏ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á –∑–º—ñ–Ω—é—î –≤–∏–±—ñ—Ä —É —Å–ø–∏—Å–∫—É
    select.addEventListener('change', function() {
        if (this.value === 'OTHER_OPTION_MARKER') {
            // –û–±—Ä–∞–ª–∏ "–Ü–Ω—à–µ"
            customBlock.style.display = 'block';
            customInput.focus();
            realInput.value = customInput.value;
        } else {
            // –û–±—Ä–∞–ª–∏ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∏–π –≤–∞—Ä—ñ–∞–Ω—Ç
            customBlock.style.display = 'none';
            realInput.value = this.value;
        }
    });

    // 3. –ö–æ–ª–∏ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á –ø–∏—à–µ –≤—Ä—É—á–Ω—É (–≤ —Ä–µ–∂–∏–º—ñ "–Ü–Ω—à–µ")
    customInput.addEventListener('input', function() {
        if (select.value === 'OTHER_OPTION_MARKER') {
            realInput.value = this.value;
        }
    });
});
</script>
{% endblock %}