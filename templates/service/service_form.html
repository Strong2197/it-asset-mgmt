{% extends 'base.html' %}

{% block content %}
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />

<style>
    .select2-container .select2-selection--single { height: 38px !important; border: 1px solid #ced4da !important; display: flex; align-items: center; }
    .select2-container--default .select2-selection--single .select2-selection__arrow { height: 36px !important; }
    .select2-search__field:focus { outline: none !important; box-shadow: none !important; }
</style>

<div class="row">
    <div class="col-lg-8 mb-4">
        <div class="card shadow-sm">
            <div class="card-header bg-warning text-dark"><h4 class="mb-0">{{ title }}</h4></div>
            <div class="card-body">
                <form method="post" id="service-form">
                    {% csrf_token %}
                    {% for field in form %}
                    <div class="mb-3">
                        {% if field.name == 'department' %}
                            <label class="form-label fw-bold">–í—ñ–¥–¥—ñ–ª</label>
                            <select name="{{ field.name }}" id="id_department" class="form-control" style="width: 100%;">
                                {% if field.value %}<option value="{{ field.value }}" selected>{{ field.value }}</option>{% endif %}
                                <option></option>
                                {% for dept in departments %}{% if dept != field.value %}<option value="{{ dept }}">{{ dept }}</option>{% endif %}{% endfor %}
                            </select>
                        {% elif field.name == 'requester_name' %}
                            <label class="form-label fw-bold">{{ field.label }}</label>
                            <select name="{{ field.name }}" id="id_requester_name" class="form-control" style="width: 100%;">
                                {% if field.value %}<option value="{{ field.value }}" selected>{{ field.value }}</option>{% endif %}
                                <option></option>
                                {% for name in requesters %}{% if name != field.value %}<option value="{{ name }}">{{ name }}</option>{% endif %}{% endfor %}
                            </select>
                        {% elif field.name == 'is_completed' %}
                            <div class="form-check">{{ field }} <label class="form-check-label fw-bold">{{ field.label }}</label></div>
                        {% else %}
                            <label class="form-label fw-bold">{{ field.label }}</label> {{ field }}
                        {% endif %}
                    </div>
                    {% endfor %}

                    <hr>
                    <label class="form-label fw-bold mb-3">–°–ø–∏—Å–æ–∫ –∫–∞—Ä—Ç—Ä–∏–¥–∂—ñ–≤:</label>
                    {{ formset.management_form }}
                    <div id="items-container">
                        {% for item_form in formset %}
                        <div class="card mb-2 border-secondary item-row">
                            <div class="card-body p-2">
                                {% for hidden in item_form.hidden_fields %}{{ hidden }}{% endfor %}
                                <div class="row g-2 align-items-center">
                                    <div class="col-md-7">
                                        <div class="d-flex gap-2 mb-1">
                                            <div class="flex-grow-1">{{ item_form.item_name }}</div>
                                            <button type="button" class="btn btn-outline-secondary btn-sm toggle-note-btn" title="–î–æ–¥–∞—Ç–∏ –ø—Ä–∏–º—ñ—Ç–∫—É">
                                                <i class="bi bi-chat-left-text"></i>
                                            </button>
                                        </div>
                                        <div class="custom-name-wrapper" style="display:none;">{{ item_form.custom_name }}</div>

                                        <div class="note-wrapper mt-1" style="{% if not item_form.note.value %}display:none;{% endif %}">
                                            <div class="input-group input-group-sm">
                                                {{ item_form.note }}
                                                <button type="button" class="btn btn-light border emoji-trigger" title="–°–º–∞–π–ª–∏–∫">üòä</button>
                                            </div>
                                        </div>

                                    </div>
                                    <div class="col-md-3">
                                        <div class="input-group input-group-sm"><span class="input-group-text">–ö-—Ç—å</span>{{ item_form.quantity }}</div>
                                    </div>
                                    <div class="col-md-2 text-end">
                                        {% if formset.can_delete %}
                                            <div class="d-none">{{ item_form.DELETE }}</div>
                                            <button type="button" class="btn btn-outline-danger btn-sm delete-row-btn"><i class="bi bi-trash"></i></button>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>

                    <button type="button" id="add-item" class="btn btn-outline-primary btn-sm mt-2 mb-3"><i class="bi bi-plus-lg"></i> –î–æ–¥–∞—Ç–∏ –ø–æ–∑–∏—Ü—ñ—é</button>

                    <div class="d-flex justify-content-between mt-4">
                        <a href="{% url 'service_list' %}" class="btn btn-secondary">–°–∫–∞—Å—É–≤–∞—Ç–∏</a>
                        <button type="submit" class="btn btn-warning shadow-sm">üíæ –ó–±–µ—Ä–µ–≥—Ç–∏</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div class="col-lg-4">
        <div class="card shadow-sm border-0 sticky-top" style="top: 20px; z-index: 1;">
            <div class="card-header bg-info text-white d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="bi bi-info-circle"></i> –ö–æ–¥–∏ –≤—ñ–¥–¥—ñ–ª—ñ–≤</h5>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-striped table-hover mb-0" style="font-size: 0.9rem;">
                        <thead class="table-light">
                            <tr><th class="ps-3">–ù–∞–∑–≤–∞ –≤—ñ–¥–¥—ñ–ª—É</th><th class="text-end pe-3">–ö–æ–¥</th></tr>
                        </thead>
                        <tbody>
                            <tr><td class="ps-3">–Ü–≤–∞–Ω–æ-–§—Ä–∞–Ω–∫—ñ–≤—Å—å–∫–∏–π</td><td class="text-end pe-3 fw-bold">2610</td></tr>
                            <tr><td class="ps-3">–Ø—Ä–µ–º—á–∞–Ω—Å—å–∫–∏–π</td><td class="text-end pe-3 fw-bold">2612</td></tr>
                            <tr><td class="ps-3">–ì–æ—Ä–æ–¥–µ–Ω–∫—ñ–≤—Å—å–∫–∏–π</td><td class="text-end pe-3 fw-bold">2616</td></tr>
                            <tr><td class="ps-3">–î–æ–ª–∏–Ω—Å—å–∫–∏–π</td><td class="text-end pe-3 fw-bold">2617</td></tr>
                            <tr><td class="ps-3">–ö–æ–ª–æ–º–∏–π—Å—å–∫–∏–π</td><td class="text-end pe-3 fw-bold">2619</td></tr>
                            <tr><td class="ps-3">–ö–æ—Å—ñ–≤—Å—å–∫–∏–π</td><td class="text-end pe-3 fw-bold">2620</td></tr>
                            <tr><td class="ps-3">–ù–∞–¥–≤—ñ—Ä–Ω—è–Ω—Å—å–∫–∏–π</td><td class="text-end pe-3 fw-bold">2621</td></tr>
                            <tr><td class="ps-3">–†–æ–≥–∞—Ç–∏–Ω—Å—å–∫–∏–π</td><td class="text-end pe-3 fw-bold">2622</td></tr>
                            <tr><td class="ps-3">–¢–∏—Å–º–µ–Ω–∏—Ü—å–∫–∏–π</td><td class="text-end pe-3 fw-bold">2626</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="card-footer bg-light text-muted small"><i class="bi bi-lightbulb"></i> –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–π—Ç–µ —Ü—ñ –∫–æ–¥–∏ –ø—Ä–∏ –∑–∞–ø–æ–≤–Ω–µ–Ω–Ω—ñ –ø–æ–ª—è "–í—ñ–¥–¥—ñ–ª".</div>
        </div>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

<script>
// –î–æ–¥–∞—î–º–æ async, —â–æ–± –º–æ–∂–Ω–∞ –±—É–ª–æ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏ await –¥–ª—è —ñ–º–ø–æ—Ä—Ç—É
$(document).ready(async function() {

    // --- –î–ò–ù–ê–ú–Ü–ß–ù–ò–ô –Ü–ú–ü–û–†–¢ EMOJI BUTTON ---
    let EmojiButtonClass = null;
    try {
        // –Ü–º–ø–æ—Ä—Ç—É—î–º–æ –º–æ–¥—É–ª—å —è–∫ –∑–º—ñ–Ω–Ω—É
        const module = await import('https://cdn.jsdelivr.net/npm/@joeattardi/emoji-button@4.6.4/dist/index.min.js');
        EmojiButtonClass = module.EmojiButton;
    } catch (error) {
        console.error("–ù–µ –≤–¥–∞–ª–æ—Å—è –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ EmojiButton:", error);
    }

    // --- –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è Select2 ---
    $('#id_requester_name').select2({ tags: true, placeholder: "–û–±–µ—Ä—ñ—Ç—å –∞–±–æ –≤–≤–µ–¥—ñ—Ç—å –ü–Ü–ë...", allowClear: true });
    $('#id_department').select2({ tags: true, placeholder: "–û–±–µ—Ä—ñ—Ç—å –∞–±–æ –≤–≤–µ–¥—ñ—Ç—å –≤—ñ–¥–¥—ñ–ª...", allowClear: true });
    $(document).on('select2:open', function(e) { document.querySelector('.select2-search__field').focus(); });

    $('#id_requester_name').on('select2:select change', function (e) {
        const name = $(this).val();
        const $deptSelect = $('#id_department');
        if (name && name.length > 2) {
            fetch(`{% url 'get_last_department' %}?name=${encodeURIComponent(name)}`)
                .then(response => response.json())
                .then(data => {
                    if (data.found && data.department) {
                        if ($deptSelect.find("option[value='" + data.department + "']").length) {
                            $deptSelect.val(data.department).trigger('change');
                        } else {
                            var newOption = new Option(data.department, data.department, true, true);
                            $deptSelect.append(newOption).trigger('change');
                        }
                    }
                });
        }
    });

    const container = document.getElementById('items-container');
    const addButton = document.getElementById('add-item');
    const totalForms = document.getElementById('id_items-TOTAL_FORMS');

    // --- 1. –õ–û–ì–Ü–ö–ê –°–ú–ê–ô–õ–ò–ö–Ü–í ---
    let picker = null;
    let currentInputForEmoji = null;

    // –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑—É—î–º–æ –ø—ñ–∫–µ—Ä, —Ç—ñ–ª—å–∫–∏ —è–∫—â–æ –∫–ª–∞—Å –∑–∞–≤–∞–Ω—Ç–∞–∂–∏–≤—Å—è
    if (EmojiButtonClass) {
        picker = new EmojiButtonClass({
            position: 'bottom-start',
            emojiSize: '1.5em',
            autoHide: false,
            zIndex: 9999
        });

        picker.on('emoji', selection => {
            if (currentInputForEmoji) {
                currentInputForEmoji.value += selection.emoji;
                currentInputForEmoji.focus();
            }
        });
    }

    // --- 2. –ì–û–õ–û–í–ù–ò–ô –û–ë–†–û–ë–ù–ò–ö –ö–õ–Ü–ö–Ü–í ---
    container.addEventListener('click', function(e) {

        // –ê) –ö–ª—ñ–∫ –ø–æ –∫–Ω–æ–ø—Ü—ñ "–°–º–∞–π–ª–∏–∫"
        const emojiBtn = e.target.closest('.emoji-trigger');
        if (emojiBtn) {
            if (picker) {
                const inputGroup = emojiBtn.closest('.input-group');
                currentInputForEmoji = inputGroup.querySelector('input');
                picker.togglePicker(emojiBtn);
            } else {
                alert("–°–º–∞–π–ª–∏–∫–∏ —â–µ –∑–∞–≤–∞–Ω—Ç–∞–∂—É—é—Ç—å—Å—è –∞–±–æ –≤–∏–Ω–∏–∫–ª–∞ –ø–æ–º–∏–ª–∫–∞.");
            }
            return;
        }

        // –ë) –ö–ª—ñ–∫ –ø–æ –∫–Ω–æ–ø—Ü—ñ "–ü—Ä–∏–º—ñ—Ç–∫–∞"
        const noteBtn = e.target.closest('.toggle-note-btn');
        if (noteBtn) {
            toggleNoteField(noteBtn);
            return;
        }

        // –í) –ö–ª—ñ–∫ –ø–æ "–í–∏–¥–∞–ª–∏—Ç–∏ —Ä—è–¥–æ–∫"
        if (e.target.closest('.delete-row-btn')) {
            const row = e.target.closest('.item-row');
            const deleteCheckbox = row.querySelector('input[name$="-DELETE"]');
            if (deleteCheckbox) { deleteCheckbox.checked = true; row.style.display = 'none'; } else { row.remove(); }
        }
    });

    function toggleNoteField(button) {
        const row = button.closest('.item-row');
        const wrapper = row.querySelector('.note-wrapper');
        const input = wrapper.querySelector('input');

        if (wrapper.style.display === 'none') {
            wrapper.style.display = 'block';
            button.classList.add('active', 'btn-secondary', 'text-white');
            if (input) input.focus();
        } else {
            wrapper.style.display = 'none';
            button.classList.remove('active', 'btn-secondary', 'text-white');
            if (input) input.value = '';
        }
    }

    function toggleCustomField(selectElement) {
        const row = selectElement.closest('.item-row');
        const wrapper = row.querySelector('.custom-name-wrapper');
        const input = wrapper.querySelector('input');
        if (selectElement.value === '–Ü–Ω—à–µ') {
            wrapper.style.display = 'block';
            if (input) { input.style.display = 'block'; input.required = true; }
        } else {
            wrapper.style.display = 'none';
            if (input) { input.value = ''; input.required = false; }
        }
    }

    container.addEventListener('change', function(e) {
        if (e.target.matches('select') && e.target.name.includes('item_name')) toggleCustomField(e.target);
    });

    const allSelects = container.querySelectorAll('select[name$="item_name"]');
    allSelects.forEach(select => toggleCustomField(select));

    addButton.addEventListener('click', function() {
        const formsCount = parseInt(totalForms.value);
        const firstRow = container.querySelector('.item-row');
        const newRow = firstRow.cloneNode(true);
        const regex = new RegExp(`items-(\\d+)-`, 'g');
        newRow.innerHTML = newRow.innerHTML.replace(regex, `items-${formsCount}-`);

        newRow.querySelectorAll('input, select').forEach(el => {
            if (el.type !== 'hidden') {
                el.value = '';
                if (el.name.includes('quantity')) el.value = 1;
            }
            if (el.type === 'checkbox') el.checked = false;
        });

        const customWrapper = newRow.querySelector('.custom-name-wrapper');
        if(customWrapper) customWrapper.style.display = 'none';

        const noteWrapper = newRow.querySelector('.note-wrapper');
        if(noteWrapper) noteWrapper.style.display = 'none';

        const noteBtn = newRow.querySelector('.toggle-note-btn');
        if(noteBtn) noteBtn.classList.remove('active', 'btn-secondary', 'text-white');

        newRow.style.display = 'block';
        container.appendChild(newRow);
        totalForms.value = formsCount + 1;
    });
});
</script>
{% endblock %}